<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <!-- í˜ì´ì§€ ìŠ¤íƒ€ì¼ -->
        <link rel="stylesheet" href="/css/fund/fund_theme_list.css" />
        <!-- í”„ë ˆê·¸ë¨¼íŠ¸ ìŠ¤íƒ€ì¼ -->
        <link rel="stylesheet" href="/css/userHeader.css" />
        <link rel="stylesheet" href="/css/footer.css" />
        <link rel="stylesheet" href="/css/fundMainHeader.css" />
        <!-- ì œëª© -->
        <title>í€ë“œ í…Œë§ˆ ëª©ë¡</title>
    </head>
    <body>
        <!-- í—¤ë” ì˜ì—­ -->
        <th:block th:replace="fragments/userHeader :: userHeader"></th:block>
		<th:block th:replace="fragments/fundMainHeader :: fundMainHeader"></th:block>
        <!-- ë©”ì¸ ì˜ì—­ -->
        <div class="container">
            <!-- ì œëª© ì˜ì—­ -->
            <div class="title-container">
                <h1 class="title">ìˆ˜ìµë¥  BEST í€ë“œ ëª©ë¡</h1>
                <span class="title-user-info">
                    í˜„ì¬ íšŒì›ë‹˜ì˜ íˆ¬ìì„±í–¥ì€
                    <span id="invest-type">Unknown</span>ì…ë‹ˆë‹¤
                </span>
            </div>

            <!-- í€ë“œ ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ -->
            <div id="fund-content" class="fund-content">
                <!-- í€ë“œ ë¦¬ìŠ¤íŠ¸ ì˜ì—­ -->
                <div id="fund-list" class="fund-list">
                    <!-- í€ë“œ ì•„ì´í…œ ì˜ì—­ -->
                </div>
            </div>

            <!-- â”€â”€ ë¡œë”© ì˜¤ë²„ë ˆì´ â”€â”€ -->
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>í€ë“œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
        </div>

        <!-- í•˜ë‹¨ ê³ ì • ë¹„êµë°” -->
        <div class="compare-bar" id="compareBar">
            <div class="compare-bar-content">
                <div class="compare-info">
                    <div class="compare-count" id="compareCount">0ê°œ ì„ íƒ</div>
                    <div class="selected-funds-preview" id="fundsPreview">
                        <!-- ì„ íƒëœ í€ë“œë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                </div>

                <div class="compare-actions">
                    <button class="clear-all-btn" id="clearAllBtn">
                        ì „ì²´ í•´ì œ
                    </button>
                    <button class="compare-btn" id="compareBtn" disabled>
                        í€ë“œ ë¹„êµí•˜ê¸°
                    </button>
                </div>
            </div>
        </div>

        <!-- ë¹„êµ ëª¨ë‹¬ -->
        <div class="modal-overlay" id="compareModal">
            <div class="modal-container">
                <!-- ëª¨ë‹¬ í—¤ë” -->
                <div class="modal-header">
                    <h2 class="modal-title">
                        <!-- <span class="modal-icon">ğŸ“Š</span> -->
                        í€ë“œ ë¹„êµ ë¶„ì„
                    </h2>
                    <div
                        class="modal-close-btn"
                        id="modalCloseBtn"
                        aria-label="ëª¨ë‹¬ ë‹«ê¸°"
                        role="button"
                        tabindex="0"
                    >
                        <svg
                            width="24"
                            height="24"
                            viewBox="0 0 24 24"
                            fill="none"
                        >
                            <path
                                d="M18 6L6 18M6 6L18 18"
                                stroke="currentColor"
                                stroke-width="2"
                                stroke-linecap="round"
                            />
                        </svg>
                    </div>
                </div>

                <!-- ëª¨ë‹¬ ë°”ë”” -->
                <div class="modal-body">
                    <!-- ë¹„êµ í…Œì´ë¸” ì»¨í…Œì´ë„ˆ -->
                    <div class="compare-table-container">
                        <table class="compare-table" id="compareTable">
                            <thead>
                                <tr>
                                    <th class="table-header-label">êµ¬ë¶„</th>
                                    <!-- í€ë“œ ì»¬ëŸ¼ë“¤ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                                </tr>
                            </thead>
                            <tbody id="compareTableBody">
                                <!-- ë¹„êµ ë°ì´í„°ê°€ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                            </tbody>
                        </table>
                    </div>

                    <!-- ë¶„ì„ ì½˜í…ì¸  ì˜ì—­ -->
                    <div
                        class="aiAnaylseContainer"
                        id="aiAnaylseContainer"
                    ></div>

                    <!-- ëª¨ë‹¬ ë²„íŠ¼ ì˜ì—­ -->
                    <div class="modal-actions">
                        <button
                            class="modal-btn modal-btn-secondary"
                            id="aiAnalyseBtn"
                        >
                            AI ë¶„ì„
                        </button>
                        <button
                            class="modal-btn modal-btn-primary"
                            id="modalCloseBtn2"
                        >
                            í™•ì¸
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- í‘¸í„° ì˜ì—­ -->
        <th:block th:replace="fragments/footer :: siteFooter"></th:block>
    </body>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let investType = null;
        let investTypeName = "";
        const selectedFunds = [];
        const MAX_COMPARE_COUNT = 3;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        document.addEventListener("DOMContentLoaded", function () {
            // íˆ¬ìì„±í–¥ ì •ë³´ ì½ê¸°
            const investTypeElement = document.querySelector(
                'meta[name="invest-type"]'
            );
            const userIdElement = document.querySelector(
                'meta[name="user-id"]'
            );
            if (investTypeElement) {
                investType = parseInt(
                    investTypeElement.getAttribute("content")
                );
            }

            setInvestTypeInfo();
            loadBestFunds();
        });

        // íˆ¬ìì„±í–¥ ì •ë³´ í‘œì‹œ
        function setInvestTypeInfo() {
            const investTypeNames = {
                1: "ì•ˆì •í˜•",
                2: "ì•ˆì • ì¶”êµ¬í˜•",
                3: "ìœ„í—˜ ì¤‘ë¦½í˜•",
                4: "ì ê·¹ íˆ¬ìí˜•",
                5: "ê³µê²© íˆ¬ìí˜•",
            };

            investTypeName = investTypeNames[investType] || "ì•Œ ìˆ˜ ì—†ìŒ";

            // íˆ¬ìì„±í–¥ ìš”ì†Œ ê°€ì ¸ì˜´
            const investTypeElement = document.getElementById("invest-type");
            if (investTypeElement) {
                // í…ìŠ¤íŠ¸ ì„¤ì •
                investTypeElement.textContent = investTypeName;

                // ê¸°ì¡´ í´ë˜ìŠ¤ ì œê±°
                investTypeElement.className = "";

                // íˆ¬ìì„±í–¥ì— ë§ëŠ” í´ë˜ìŠ¤ ì¶”ê°€
                if (investType >= 1 && investType <= 5) {
                    investTypeElement.classList.add(
                        `invest-type-${investType}`
                    );
                }
            }
        }

        // APIë¡œ í€ë“œ ë¦¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
        async function loadBestFunds() {
            showLoading(true);
            try {
                const apiUrl = `/api/funds/best-return?investType=${investType}`;
                const response = await fetch(apiUrl);
                const data = await response.json();

                if (data.success) {
                    renderFunds(data.data.funds);
                    console.log("ìˆ˜ìµë¥  BEST í€ë“œ ë¶ˆëŸ¬ì˜¤ê¸° ì„±ê³µ");
                } else {
                    console.error("í€ë“œ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", data.message);
                }
            } catch (error) {
                console.error("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:", error);
            } finally {
                showLoading(false);
            }
        }

        // í€ë“œ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
        function renderFunds(funds) {
            const fundList = document.getElementById("fund-list");
            fundList.innerHTML = "";

            funds.forEach((fund) => {
                const fundElement = createFundElement(fund);
                restoreSelectionState(fundElement, fund.fundId);
                fundList.appendChild(fundElement);
            });
        }

        // í€ë“œ ìš”ì†Œ ìƒì„±
        // ê°œë³„ í€ë“œ ë°ì´í„°ë¥¼ HTML ìš”ì†Œë¡œ ë³€í™˜
        function createFundElement(fund) {
            const fundDiv = document.createElement("div");
            fundDiv.className = "fund-item";
            fundDiv.setAttribute("data-id", fund.fundId);

            // ìˆ˜ìµë¥  í´ë˜ìŠ¤ ê²°ì • í•¨ìˆ˜
            const getReturnClass = (value) => {
                if (value === null || value === undefined) return "";
                // return value >= 0 ? "pos" : "neg";
                if (value > 0) {
                    return "pos";
                } else if (value < 0) {
                    return "neg";
                } else {
                    return "zero";
                }
            };

            // ìˆ˜ìµë¥  í¬ë§·íŒ… í•¨ìˆ˜
            const formatReturn = (value) => {
                if (value === null || value === undefined) return "0.00%";
                return `${value.toFixed(2)}%`;
            };

            // ìˆ«ì í¬ë§·íŒ… í•¨ìˆ˜
            const formatNumber = (value) => {
                if (value === null || value === undefined) return "0";
                return value.toLocaleString();
            };

            // ë‚ ì§œ í¬ë§·íŒ… í•¨ìˆ˜
            const formatDate = (dateStr) => {
                if (!dateStr) return "";
                // LocalDateëŠ” "YYYY-MM-DD" í˜•íƒœë¡œ ì˜¤ë¯€ë¡œ "-"ë¥¼ "."ë¡œ ë³€ê²½
                return dateStr.replace(/-/g, ".");
            };

            // ìœ„í—˜ë“±ê¸‰ í´ë˜ìŠ¤ ê²°ì •
            const getRiskClass = (riskLevel) => {
                return `risk-${riskLevel}`;
            };

            // íˆ¬ìì§€ì—­ ë°°ì§€ ìƒì„± í•¨ìˆ˜
            const createRegionBadge = (region) => {
                return region && region.trim() !== ""
                    ? `<span class="badge region">${region}</span>`
                    : "";
            };

            // ìœ„í—˜ë“±ê¸‰ í…ìŠ¤íŠ¸ ê²°ì •
            const getRiskText = (riskLevel) => {
                const riskTexts = {
                    1: "ë§¤ìš°ë†’ì€ìœ„í—˜(1ë“±ê¸‰)",
                    2: "ë†’ì€ìœ„í—˜(2ë“±ê¸‰)",
                    3: "ë‹¤ì†Œë†’ì€ìœ„í—˜(3ë“±ê¸‰)",
                    4: "ë³´í†µìœ„í—˜(4ë“±ê¸‰)",
                    5: "ë‚®ì€ìœ„í—˜(5ë“±ê¸‰)",
                    6: "ë§¤ìš°ë‚®ì€ìœ„í—˜(6ë“±ê¸‰)",
                };
                return riskTexts[riskLevel] || `ìœ„í—˜ë“±ê¸‰(${riskLevel}ë“±ê¸‰)`;
            };

            fundDiv.innerHTML = `
                <!-- ë©”íƒ€ ë°ì´í„° -->
                <section class="fund-item-section fund-meta">
                    <div class="fund-name-container">
                        <h3 class="fund-name">
                            <a href="/fund/${
                                fund.fundId
                            }" class="fund-name-link">
                                ${fund.fundName || ""}
                            </a>
                        </h3>
                    </div>
                    <ul class="fund-detail">
                        <li>ì„¤ì •ì¼&nbsp;${formatDate(fund.establishDate)}</li>
                        <li>ê¸°ì¤€ê°€&nbsp;${formatNumber(fund.nav)}</li>
                        <li>ìˆœìì‚°&nbsp;${fund.aum || 0}ì–µ</li>
                    </ul>
                    <div class="badge-list">
                        <span class="badge company">${
                            fund.managementCompany || ""
                        }</span>
                        <span class="badge type">${fund.fundType || ""}</span>
                        ${createRegionBadge(fund.investmentRegion)}
                        <span class="badge risk ${getRiskClass(
                            fund.riskLevel
                        )}">
                            ${getRiskText(fund.riskLevel)}
                        </span>
                    </div>
                    <div class="fund-item-section fund-compare-check">
                        <button class="compare-add-btn"
                                data-fund-id="${fund.fundId}"
                                data-fund-name="${fund.fundName || ""}">
                            ë¹„êµë‹´ê¸°
                        </button>
                    </div>
                </section>

                <!-- ìˆ˜ìµë¥  -->
                <section class="fund-item-section fund-return">
                    <div class="stat">
                        <span>1ê°œì›”</span>
                        <strong class="${getReturnClass(
                            fund.return1m
                        )}">${formatReturn(fund.return1m)}</strong>
                    </div>
                    <div class="stat">
                        <span>3ê°œì›”</span>
                        <strong class="${getReturnClass(
                            fund.return3m
                        )}">${formatReturn(fund.return3m)}</strong>
                    </div>
                    <div class="stat">
                        <span>6ê°œì›”</span>
                        <strong class="${getReturnClass(
                            fund.return6m
                        )}">${formatReturn(fund.return6m)}</strong>
                    </div>
                    <div class="stat">
                        <span>12ê°œì›”</span>
                        <strong class="${getReturnClass(
                            fund.return12m
                        )}">${formatReturn(fund.return12m)}</strong>
                    </div>
                    <div class="stat">
                        <span>ëˆ„ì </span>
                        <strong class="${getReturnClass(
                            fund.returnSince
                        )}">${formatReturn(fund.returnSince)}</strong>
                    </div>
                </section>
            `;
            return fundDiv;
        }
        function formatNumber(num) {
            return new Intl.NumberFormat().format(num);
        }
        function formatDate(dateStr) {
            return dateStr ? dateStr.replace(/-/g, ".") : "-";
        }
        function formatReturn(value) {
            return value != null ? `${value.toFixed(2)}%` : "-";
        }
        // ë¡œë”© í‘œì‹œ
        function showLoading(show) {
            document.getElementById("loading").style.display = show
                ? "flex"
                : "none";
        }
        // ì„ íƒ ìƒíƒœ ë³µì›
        function restoreSelectionState(fundElement, fundId) {
            const isSelected = selectedFunds.some((f) => f.id == fundId);
            if (isSelected) {
                fundElement.classList.add("selected");
                const btn = fundElement.querySelector(".compare-add-btn");
                btn.classList.add("selected");
                btn.textContent = "ì„ íƒë¨";
            }
        }

        // ë¹„êµë‹´ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        document.addEventListener("click", function (e) {
            if (e.target.classList.contains("compare-add-btn")) {
                const fundId = e.target.dataset.fundId;
                const fundName = e.target.dataset.fundName;
                const fundItem = e.target.closest(".fund-item");

                toggleFundSelection(fundId, fundName, fundItem, e.target);
            }
        });

        // í€ë“œ ì„ íƒ/í•´ì œ í† ê¸€
        function toggleFundSelection(fundId, fundName, fundItem, button) {
            const existingIndex = selectedFunds.findIndex(
                (f) => f.id === fundId
            );

            if (existingIndex > -1) {
                // ì„ íƒ í•´ì œ
                selectedFunds.splice(existingIndex, 1);
                fundItem.classList.remove("selected");
                button.classList.remove("selected");
                button.textContent = "ë¹„êµë‹´ê¸°";
            } else {
                // ìƒˆë¡œ ì„ íƒ
                if (selectedFunds.length >= MAX_COMPARE_COUNT) {
                    alert(`ìµœëŒ€ ${MAX_COMPARE_COUNT}ê°œê¹Œì§€ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
                    return;
                }

                selectedFunds.push({
                    id: fundId,
                    name: fundName,
                    // ë‚˜ì¤‘ì— í•„ìš”í•œ ì¶”ê°€ ë°ì´í„°ë“¤...
                });
                fundItem.classList.add("selected");
                button.classList.add("selected");
                button.textContent = "ì„ íƒë¨";
            }

            updateCompareBar();
        }

        // ë¹„êµë°” ì—…ë°ì´íŠ¸
        function updateCompareBar() {
            const compareBar = document.getElementById("compareBar");
            const compareCount = document.getElementById("compareCount");
            const fundsPreview = document.getElementById("fundsPreview");
            const compareBtn = document.getElementById("compareBtn");

            if (selectedFunds.length > 0) {
                compareBar.classList.add("show");
                compareCount.textContent = `${selectedFunds.length}ê°œ ì„ íƒ`;

                fundsPreview.innerHTML = selectedFunds
                    .map(
                        (fund, index) => `
                                <div class="fund-preview">
                                    <div class="fund-preview-name">${fund.name}</div>
                                    <button class="fund-remove-btn" onclick="removeFund(${index})" title="ì œê±°">Ã—</button>
                                </div>
                            `
                    )
                    .join("");

                compareBtn.disabled = selectedFunds.length < 2;
            } else {
                compareBar.classList.remove("show");
            }
        }

        // ê°œë³„ í€ë“œ ì œê±°
        function removeFund(index) {
            const fund = selectedFunds[index];
            selectedFunds.splice(index, 1);

            // í•´ë‹¹ í€ë“œ ì•„ì´í…œì˜ ì„ íƒ ìƒíƒœ í•´ì œ
            const fundItem = document.querySelector(`[data-id="${fund.id}"]`);
            if (fundItem) {
                fundItem.classList.remove("selected");
                const btn = fundItem.querySelector(".compare-add-btn");
                btn.classList.remove("selected");
                btn.textContent = "ë¹„êµë‹´ê¸°";
            }

            updateCompareBar();
        }

        // ì „ì²´ í•´ì œ
        document
            .getElementById("clearAllBtn")
            .addEventListener("click", function () {
                selectedFunds.length = 0;
                document
                    .querySelectorAll(".fund-item.selected")
                    .forEach((item) => {
                        item.classList.remove("selected");
                        const btn = item.querySelector(".compare-add-btn");
                        if (btn) {
                            btn.classList.remove("selected");
                            btn.textContent = "ë¹„êµë‹´ê¸°";
                        }
                    });
                updateCompareBar();
            });

        // ë¹„êµí•˜ê¸° ë²„íŠ¼ í´ë¦­
        document
            .getElementById("compareBtn")
            .addEventListener("click", function () {
                if (selectedFunds.length >= 2) {
                    openCompareModal();
                } else {
                    alert("ìµœì†Œ 2ê°œ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.");
                }
            });

        // ë¹„êµ ëª¨ë‹¬ ë‹«ê¸°
        document
            .getElementById("modalCloseBtn")
            .addEventListener("click", function () {
                document
                    .getElementById("compareModal")
                    .classList.remove("show");
            });

        // ë¹„êµ ëª¨ë‹¬ ë‹«ê¸°2
        document
            .getElementById("modalCloseBtn2")
            .addEventListener("click", function () {
                document
                    .getElementById("compareModal")
                    .classList.remove("show");
            });
        // ë¹„êµ ëª¨ë‹¬ ë‹«ê¸°
        function closeCompareModal() {
            const modal = document.getElementById("compareModal");
            modal.classList.remove("show");

            // AI ë¶„ì„ ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™”
            const aiAnaylseContainer =
                document.getElementById("aiAnaylseContainer");
            if (aiAnaylseContainer) {
                aiAnaylseContainer.innerHTML = "";
            }

            // ìŠ¤í¬ë¡¤ ë³µì›
            document.body.style.overflow = "auto";
        }
        // ë¹„êµ ëª¨ë‹¬ ì—´ê¸°
        function openCompareModal() {
            if (selectedFunds.length < 2) {
                alert("ìµœì†Œ 2ê°œ ì´ìƒì˜ í€ë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }

            const modal = document.getElementById("compareModal");
            modal.classList.add("show");

            // ëª¨ë‹¬ ë‚´ìš© ìƒì„±
            renderCompareModal();

            // ìŠ¤í¬ë¡¤ ë°©ì§€
            document.body.style.overflow = "hidden";
        }
        // ë¹„êµ ëª¨ë‹¬ ë‚´ìš© ë Œë”ë§
        function renderCompareModal() {
            //updateCompareSummary();
            renderCompareTable();

            // ì°¨íŠ¸ê°€ í•„ìš”í•œ ê²½ìš°
            // renderReturnsChart();
        }
        // ë¹„êµ í…Œì´ë¸” ë Œë”ë§
        function renderCompareTable() {
            const table = document.getElementById("compareTable");
            const tbody = document.getElementById("compareTableBody");

            // í…Œì´ë¸” í—¤ë” ìƒì„±
            renderTableHeader(table, selectedFunds);

            // í…Œì´ë¸” ë°”ë”” ìƒì„±
            renderTableBody(tbody, selectedFunds);
        }
        // í…Œì´ë¸” í—¤ë” ë Œë”ë§
        function renderTableHeader(table, funds) {
            const thead = table.querySelector("thead tr");

            // ê¸°ì¡´ í€ë“œ ì»¬ëŸ¼ ì œê±° (ì²« ë²ˆì§¸ thëŠ” ìœ ì§€)
            const existingHeaders = thead.querySelectorAll(
                "th:not(.table-header-label)"
            );
            existingHeaders.forEach((th) => th.remove());

            // í€ë“œë³„ í—¤ë” ì¶”ê°€
            funds.forEach((fund, index) => {
                const th = document.createElement("th");
                th.className = "fund-header-cell";
                th.innerHTML = `
                        <span class="fund-header-name">${truncateText(
                            fund.name,
                            50
                        )}</span>
                `;
                thead.appendChild(th);
            });
        }
        // í…Œì´ë¸” ë°”ë”” ë Œë”ë§
        function renderTableBody(tbody, funds) {
            tbody.innerHTML = "";
            // ë¹„êµí•  í•­ëª©ë“¤ ì •ì˜
            const compareItems = [
                {
                    label: "í€ë“œìœ í˜•",
                    key: "fundType",
                    formatter: (value) =>
                        `<div class="data-main">${value}</div>`,
                },
                {
                    label: "íˆ¬ìì§€ì—­",
                    key: "region",
                    formatter: (value) =>
                        `<div class="data-main">${value || "-"}</div>`,
                },
                {
                    label: "ìœ„í—˜ë“±ê¸‰",
                    key: "riskLevel",
                    formatter: (value) =>
                        `<span class="data-main">${getRiskText(
                            value || 4
                        )}</span>`,
                },
                {
                    label: "ìš´ìš©ì‚¬",
                    key: "managementCompany",
                    formatter: (value) =>
                        `<div class="data-main">${value || "-"}</div>`,
                },
                {
                    label: "ê¸°ì¤€ê°€",
                    key: "nav",
                    formatter: (value) => `
                                <div class="data-main">${formatNumber(
                                    value
                                )}ì›</div>
                            `,
                },
                {
                    label: "ìˆœìì‚°",
                    key: "aum",
                    formatter: (value) =>
                        `<div class="data-main">${value || "-"}ì–µì›</div>`,
                },
                {
                    label: "3ê°œì›” ìˆ˜ìµë¥ ",
                    key: "return3m",
                    formatter: (value) => formatReturnCell(value),
                },
                {
                    label: "12ê°œì›” ìˆ˜ìµë¥ ",
                    key: "return12m",
                    formatter: (value) => formatReturnCell(value),
                },
            ];

            // ê° ë¹„êµ í•­ëª©ë³„ë¡œ í–‰ ìƒì„±
            compareItems.forEach((item) => {
                const tr = document.createElement("tr");

                // ë¼ë²¨ ì…€
                const labelTd = document.createElement("td");
                labelTd.className = "row-label";
                labelTd.textContent = item.label;
                tr.appendChild(labelTd);

                // ê° í€ë“œë³„ ë°ì´í„° ì…€
                funds.forEach((fund) => {
                    const dataTd = document.createElement("td");
                    dataTd.className = "fund-data-cell";

                    // ì‹¤ì œ í€ë“œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (í˜„ì¬ëŠ” selectedFundsì— ì œí•œëœ ì •ë³´ë§Œ ìˆìŒ)
                    const fundData = getFundDataById(fund.id);
                    const value = fundData
                        ? fundData[item.key]
                        : fund[item.key] || null;

                    dataTd.innerHTML = item.formatter(value, fundData || fund);
                    tr.appendChild(dataTd);
                });

                tbody.appendChild(tr);
            });
        }
        // ìˆ˜ìµë¥  ì…€ í¬ë§·íŒ…
        function formatReturnCell(value) {
            if (value === null || value === undefined) {
                return '<div class="data-main return-neutral">-</div>';
            }

            const returnClass =
                value >= 0 ? "return-positive" : "return-negative";
            const sign = value >= 0 ? "+" : "";

            return `<div class="data-main ${returnClass}">${sign}${value.toFixed(
                2
            )}%</div>`;
        }
        // í€ë“œ IDë¡œ ìƒì„¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì‹¤ì œ ë°ì´í„°ì™€ ì—°ë™ í•„ìš”)
        function getFundDataById(fundId) {
            // í˜„ì¬ í˜ì´ì§€ì— ë¡œë“œëœ í€ë“œë“¤ì—ì„œ ì°¾ê¸°
            const fundElements = document.querySelectorAll(".fund-item");
            for (let element of fundElements) {
                if (element.dataset.id == fundId) {
                    return extractFundDataFromElement(element);
                }
            }
            return null;
        }
        // DOM ìš”ì†Œì—ì„œ í€ë“œ ë°ì´í„° ì¶”ì¶œ
        function extractFundDataFromElement(element) {
            const fundName =
                element.querySelector(".fund-name")?.textContent || "";
            const badges = element.querySelectorAll(".badge");
            const stats = element.querySelectorAll(".stat strong");
            const details = element.querySelectorAll(".fund-detail li");

            // ê¸°ë³¸ ì •ë³´ ì¶”ì¶œ
            let managementCompany = "",
                fundType = "",
                region = "",
                riskLevel = 4;
            badges.forEach((badge) => {
                if (badge.classList.contains("company"))
                    managementCompany = badge.textContent;
                if (badge.classList.contains("type"))
                    fundType = badge.textContent;
                if (badge.classList.contains("region"))
                    region = badge.textContent;
                if (badge.classList.contains("risk")) {
                    const riskMatch = badge.className.match(/risk-(\d+)/);
                    if (riskMatch) riskLevel = parseInt(riskMatch[1]);
                }
            });

            // ìˆ˜ìµë¥  ì •ë³´ ì¶”ì¶œ
            const returns = Array.from(stats).map((stat) => {
                const text = stat.textContent.replace("%", "");
                return parseFloat(text) || 0;
            });

            // ìƒì„¸ ì •ë³´ ì¶”ì¶œ
            let establishDate = "",
                nav = "",
                aum = "";
            details.forEach((detail) => {
                const text = detail.textContent;
                if (text.includes("ì„¤ì •ì¼"))
                    establishDate = text.replace("ì„¤ì •ì¼\u00A0", "");
                if (text.includes("ê¸°ì¤€ê°€"))
                    nav = text.replace("ê¸°ì¤€ê°€\u00A0", "").replace(",", "");
                if (text.includes("ìˆœìì‚°"))
                    aum = text.replace("ìˆœìì‚°\u00A0", "").replace("ì–µ", "");
            });

            return {
                name: fundName,
                managementCompany,
                fundType,
                region,
                riskLevel,
                establishDate,
                nav: parseFloat(nav) || 0,
                aum: parseInt(aum) || 0,
                return1m: returns[0] || 0,
                return3m: returns[1] || 0,
                return6m: returns[2] || 0,
                return12m: returns[3] || 0,
                returnSince: returns[4] || 0,
            };
        }

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        function truncateText(text, maxLength) {
            if (!text) return "-";
            return text.length > maxLength
                ? text.substring(0, maxLength) + "..."
                : text;
        }
        function getFundTypeFromName(name) {
            if (!name) return "-";
            return name;
        }
        function getRiskText(riskLevel) {
            const riskTexts = {
                1: "ë§¤ìš°ë†’ì€ìœ„í—˜(1ë“±ê¸‰)",
                2: "ë†’ì€ìœ„í—˜(2ë“±ê¸‰)",
                3: "ë‹¤ì†Œë†’ì€ìœ„í—˜(3ë“±ê¸‰)",
                4: "ë³´í†µìœ„í—˜(4ë“±ê¸‰)",
                5: "ë‚®ì€ìœ„í—˜(5ë“±ê¸‰)",
                6: "ë§¤ìš°ë‚®ì€ìœ„í—˜(6ë“±ê¸‰)",
            };
            return riskTexts[riskLevel] || `ìœ„í—˜ë“±ê¸‰(${riskLevel}ë“±ê¸‰)`;
        }

        // ëª¨ë‹¬ ë‹«ê¸° ì´ë²¤íŠ¸ë“¤
        document
            .getElementById("modalCloseBtn")
            .addEventListener("click", closeCompareModal);
        document
            .getElementById("modalCloseBtn2")
            .addEventListener("click", closeCompareModal);

        // ëª¨ë‹¬ ì˜¤ë²„ë ˆì´ í´ë¦­ ì‹œ ë‹«ê¸°
        document
            .getElementById("compareModal")
            .addEventListener("click", function (e) {
                if (e.target === this) {
                    closeCompareModal();
                }
            });

        // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
        document.addEventListener("keydown", function (e) {
            if (e.key === "Escape") {
                const modal = document.getElementById("compareModal");
                if (modal.classList.contains("show")) {
                    closeCompareModal();
                }
            }
        });

        // AI ë¶„ì„ ë²„íŠ¼
        document
            .getElementById("aiAnalyseBtn")
            .addEventListener("click", function (e) {
                // ì„ íƒëœ í€ë“œê°€ ìˆëŠ”ì§€ í™•ì¸
                if (!selectedFunds || selectedFunds.length === 0) {
                    alert("ë¶„ì„í•  í€ë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                    return;
                }

                // selectedFundsì—ì„œ ID ì¶”ì¶œ
                const fundIds = selectedFunds.map((fund) => fund.id);

                // URL íŒŒë¼ë¯¸í„° ìƒì„±
                const params = new URLSearchParams();

                // fundId íŒŒë¼ë¯¸í„°ë¥¼ ì—¬ëŸ¬ ê°œ ì¶”ê°€ (List<Long> ì²˜ë¦¬)
                fundIds.forEach((id) => {
                    params.append("fundId", id);
                });

                // invert íŒŒë¼ë¯¸í„° ì¶”ê°€
                params.append("invert", investType);

                // ìµœì¢… URL ìƒì„±
                const url = `/ai/compare?${params.toString()}`;
                // console.log("AI ë¶„ì„ ìš”ì²­ URL:", url);

                // AI ë¶„ì„ ì»¨í…ì¸  ìš”ì†Œ ì°¾ê¸°
                const aiAnaylseContainer =
                    document.getElementById("aiAnaylseContainer");

                if (!aiAnaylseContainer) {
                    console.error(
                        "aiAnaylseContainer ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
                    );
                    return;
                }

                // ë¡œë”© í‘œì‹œ
                aiAnaylseContainer.innerHTML = `
                            <div class="loading-analyse-container">
                                <div class="loading-analyse-spinner"></div>
                                <p>AIê°€ í€ë“œë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                            </div>
                        `;

                // AJAX ìš”ì²­
                fetch(url, {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                    },
                })
                    .then((response) => {
                        console.log("ì‘ë‹µ ìƒíƒœ:", response.status);

                        if (!response.ok) {
                            throw new Error(
                                `HTTP error! status: ${response.status}`
                            );
                        }
                        return response.text(); // String ì‘ë‹µì´ë¯€ë¡œ text()ë¡œ ë°›ê¸°
                    })
                    .then((data) => {
                        // console.log("AI ë¶„ì„ ê²°ê³¼:", data);
                        // ì„±ê³µ ì‹œ ë°›ì€ ë°ì´í„°ë¥¼ innerHTMLì— ì„¤ì •
                        aiAnaylseContainer.innerHTML = data;
                    })
                    .catch((error) => {
                        console.error("AI ë¶„ì„ ìš”ì²­ ì‹¤íŒ¨:", error);

                        // ì—ëŸ¬ ì‹œ ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
                        aiAnaylseContainer.innerHTML = `
                                <div class="error-container">
                                    <p>âŒ AI ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
                                    <p>ì˜¤ë¥˜: ${error.message}</p>
                                    <button onclick="aiAnalyseBtn()" class="retry-btn">ë‹¤ì‹œ ì‹œë„</button>
                                </div>
                            `;
                    });
            });
    </script>

    <!-- Thymeleaf ë°ì´í„° ì „ë‹¬ì„ ìœ„í•œ ë©”íƒ€ íƒœê·¸ -->
    <meta name="invest-type" th:content="${investType}" />
    <meta name="user-id" th:content="${userId}" />
</html>
