<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <!-- í˜ì´ì§€ ìŠ¤íƒ€ì¼ -->
        <link rel="stylesheet" href="/css/fund/fund_list.css" />
        <!-- í”„ë ˆê·¸ë¨¼íŠ¸ ìŠ¤íƒ€ì¼ -->
        <link rel="stylesheet" href="/css/userHeader.css" />
        <link rel="stylesheet" href="/css/footer.css" />
        <link rel="stylesheet" href="/css/fundMainHeader.css" />
        <!-- ì œëª© -->
        <title>í€ë“œ ë§ì¶¤ ëª©ë¡</title>
    </head>
    <body>
        <!-- í—¤ë” ì˜ì—­ -->
        <th:block th:replace="fragments/userHeader :: userHeader"></th:block>
        <th:block
            th:replace="fragments/fundMainHeader :: fundMainHeader"
        ></th:block>
        <!-- ë©”ì¸ ì˜ì—­ -->
        <div class="container">
            <!-- ì œëª© ì˜ì—­ -->
            <div class="title-container">
                <h1 class="title">ë§ì¶¤ í€ë“œ ëª©ë¡</h1>
                <span class="title-user-info">
                    í˜„ì¬ íšŒì›ë‹˜ì˜ íˆ¬ìì„±í–¥ì€
                    <span id="invest-type">Unknown</span>ì…ë‹ˆë‹¤
                </span>
            </div>

            <!-- í•„í„° ì˜ì—­ -->
            <form id="fundForm" class="filter-container">
                <!-- ìœ„í—˜ë“±ê¸‰ -->
                <fieldset class="row">
                    <legend class="row-label">ìœ„í—˜ë“±ê¸‰</legend>
                    <div class="options">
                        <label for="risk1">
                            <input
                                type="checkbox"
                                id="risk1"
                                name="risk"
                                value="1"
                            />
                            ë§¤ìš°ë†’ì€ìœ„í—˜(1ë“±ê¸‰)
                        </label>

                        <label for="risk2">
                            <input
                                type="checkbox"
                                id="risk2"
                                name="risk"
                                value="2"
                            />
                            ë†’ì€ìœ„í—˜(2ë“±ê¸‰)
                        </label>

                        <label for="risk3">
                            <input
                                type="checkbox"
                                id="risk3"
                                name="risk"
                                value="3"
                            />
                            ë‹¤ì†Œë†’ì€ìœ„í—˜(3ë“±ê¸‰)
                        </label>

                        <label for="risk4">
                            <input
                                type="checkbox"
                                id="risk4"
                                name="risk"
                                value="4"
                            />
                            ë³´í†µìœ„í—˜(4ë“±ê¸‰)
                        </label>

                        <label for="risk5">
                            <input
                                type="checkbox"
                                id="risk5"
                                name="risk"
                                value="5"
                            />
                            ë‚®ì€ìœ„í—˜(5ë“±ê¸‰)
                        </label>

                        <label for="risk6">
                            <input
                                type="checkbox"
                                id="risk6"
                                name="risk"
                                value="6"
                            />
                            ë§¤ìš°ë‚®ì€ìœ„í—˜(6ë“±ê¸‰)
                        </label>
                    </div>
                </fieldset>

                <!-- í€ë“œìœ í˜• -->
                <fieldset class="row">
                    <legend class="row-label">í€ë“œìœ í˜•</legend>
                    <div class="options">
                        <label for="type_bond">
                            <input
                                type="checkbox"
                                id="type_bond"
                                name="type"
                                value="ì±„ê¶Œí˜•"
                            />
                            ì±„ê¶Œí˜•
                        </label>

                        <label for="type_bmix">
                            <input
                                type="checkbox"
                                id="type_bmix"
                                name="type"
                                value="ì±„ê¶Œí˜¼í•©í˜•"
                            />
                            ì±„ê¶Œí˜¼í•©í˜•
                        </label>

                        <label for="type_smix">
                            <input
                                type="checkbox"
                                id="type_smix"
                                name="type"
                                value="ì£¼ì‹í˜¼í•©í˜•"
                            />
                            ì£¼ì‹í˜¼í•©í˜•
                        </label>

                        <label for="type_stock">
                            <input
                                type="checkbox"
                                id="type_stock"
                                name="type"
                                value="ì£¼ì‹í˜•"
                            />
                            ì£¼ì‹í˜•
                        </label>

                        <label for="type_deriv">
                            <input
                                type="checkbox"
                                id="type_deriv"
                                name="type"
                                value="íŒŒìƒìƒí’ˆí˜•"
                            />
                            íŒŒìƒìƒí’ˆí˜•
                        </label>

                        <label for="type_fof">
                            <input
                                type="checkbox"
                                id="type_fof"
                                name="type"
                                value="ì¬ê°„ì ‘íˆ¬ìí˜•"
                            />
                            ì¬ê°„ì ‘
                        </label>

                        <label for="type_etc">
                            <input
                                type="checkbox"
                                id="type_etc"
                                name="type"
                                value="ìˆ˜ìµì¦ê¶Œ_ê¸°íƒ€"
                            />
                            ìˆ˜ìµì¦ê¶Œ_ê¸°íƒ€
                        </label>
                    </div>
                </fieldset>

                <!-- íˆ¬ì ì§€ì—­ -->
                <fieldset class="row">
                    <legend class="row-label">íˆ¬ì ì§€ì—­</legend>
                    <div class="options">
                        <label for="reg_korea">
                            <input
                                type="checkbox"
                                id="reg_korea"
                                name="region"
                                value="í•œêµ­"
                            />
                            í•œêµ­
                        </label>

                        <label for="reg_global">
                            <input
                                type="checkbox"
                                id="reg_global"
                                name="region"
                                value="ê¸€ë¡œë²Œ"
                            />
                            ê¸€ë¡œë²Œ
                        </label>

                        <label for="reg_usa">
                            <input
                                type="checkbox"
                                id="reg_usa"
                                name="region"
                                value="ë¯¸êµ­"
                            />
                            ë¯¸êµ­
                        </label>

                        <label for="reg_vietnam">
                            <input
                                type="checkbox"
                                id="reg_vietnam"
                                name="region"
                                value="ë² íŠ¸ë‚¨"
                            />
                            ë² íŠ¸ë‚¨
                        </label>

                        <label for="reg_euro">
                            <input
                                type="checkbox"
                                id="reg_euro"
                                name="region"
                                value="ìœ ë¡œê¶Œ"
                            />
                            ìœ ë¡œê¶Œ
                        </label>

                        <label for="reg_brazil">
                            <input
                                type="checkbox"
                                id="reg_brazil"
                                name="region"
                                value="ë¸Œë¼ì§ˆ"
                            />
                            ë¸Œë¼ì§ˆ
                        </label>

                        <label for="reg_german">
                            <input
                                type="checkbox"
                                id="reg_german"
                                name="region"
                                value="ë…ì¼"
                            />
                            ë…ì¼
                        </label>

                        <label for="reg_china">
                            <input
                                type="checkbox"
                                id="reg_china"
                                name="region"
                                value="ì¤‘êµ­"
                            />
                            ì¤‘êµ­
                        </label>

                        <label for="reg_western_europe">
                            <input
                                type="checkbox"
                                id="reg_western_europe"
                                name="region"
                                value="ì„œìœ ëŸ½"
                            />
                            ì„œìœ ëŸ½
                        </label>

                        <label for="reg_india">
                            <input
                                type="checkbox"
                                id="reg_india"
                                name="region"
                                value="ì¸ë„"
                            />
                            ì¸ë„
                        </label>

                        <label for="reg_brics">
                            <input
                                type="checkbox"
                                id="reg_brics"
                                name="region"
                                value="ë¸Œë¦­ìŠ¤"
                            />
                            ë¸Œë¦­ìŠ¤
                        </label>

                        <label for="reg_north_america">
                            <input
                                type="checkbox"
                                id="reg_north_america"
                                name="region"
                                value="ë¶ë¯¸"
                            />
                            ë¶ë¯¸
                        </label>

                        <label for="reg_japan">
                            <input
                                type="checkbox"
                                id="reg_japan"
                                name="region"
                                value="ì¼ë³¸"
                            />
                            ì¼ë³¸
                        </label>

                        <label for="reg_south_east_asia">
                            <input
                                type="checkbox"
                                id="reg_south_east_asia"
                                name="region"
                                value="ë™ë‚¨ì•„"
                            />
                            ë™ë‚¨ì•„
                        </label>
                    </div>
                </fieldset>

                <!-- ê²€ìƒ‰ ë²„íŠ¼ -->
                <div class="row filter-btn-container">
                    <button type="submit" class="filter-btn">í•„í„° ê²€ìƒ‰</button>
                </div>
            </form>

            <!-- í€ë“œ ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ -->
            <div id="fund-content" class="fund-content">
                <!-- ê²€ìƒ‰ ê²°ê³¼ ë©”ì„¸ì§€ ì˜ì—­ -->
                <div class="message"></div>

                <!-- í€ë“œ ë¦¬ìŠ¤íŠ¸ ì˜ì—­ -->
                <div id="fund-list" class="fund-list">
                    <!-- í€ë“œ ì•„ì´í…œ ì˜ì—­ -->
                </div>

                <!-- ë”ë³´ê¸° ë²„íŠ¼ ì˜ì—­ -->
                <div class="load-more-container">
                    <button
                        id="load-more-btn"
                        class="load-more-btn"
                        onclick="loadMoreFunds()"
                    >
                        ë”ë³´ê¸°
                    </button>
                </div>
            </div>

            <!-- â”€â”€ ë¡œë”© ì˜¤ë²„ë ˆì´ â”€â”€ -->
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>í€ë“œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
        </div>

        <!-- í•˜ë‹¨ ê³ ì • ë¹„êµë°” -->
        <div class="compare-bar" id="compareBar">
            <div class="compare-bar-content">
                <div class="compare-info">
                    <div class="compare-count" id="compareCount">0ê°œ ì„ íƒ</div>
                    <div class="selected-funds-preview" id="fundsPreview">
                        <!-- ì„ íƒëœ í€ë“œë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                </div>

                <div class="compare-actions">
                    <button class="clear-all-btn" id="clearAllBtn">
                        ì „ì²´ í•´ì œ
                    </button>
                    <button class="compare-btn" id="compareBtn" disabled>
                        í€ë“œ ë¹„êµí•˜ê¸°
                    </button>
                </div>
            </div>
        </div>

        <!-- ë¹„êµ ëª¨ë‹¬ -->
        <div class="modal-overlay" id="compareModal">
            <div class="modal-container">
                <!-- ëª¨ë‹¬ í—¤ë” -->
                <div class="modal-header">
                    <h2 class="modal-title">
                        <!-- <span class="modal-icon">ğŸ“Š</span> -->
                        í€ë“œ ë¹„êµ ë¶„ì„
                    </h2>
                    <div
                        class="modal-close-btn"
                        id="modalCloseBtn"
                        aria-label="ëª¨ë‹¬ ë‹«ê¸°"
                        role="button"
                        tabindex="0"
                    >
                        <svg
                            width="24"
                            height="24"
                            viewBox="0 0 24 24"
                            fill="none"
                        >
                            <path
                                d="M18 6L6 18M6 6L18 18"
                                stroke="currentColor"
                                stroke-width="2"
                                stroke-linecap="round"
                            />
                        </svg>
                    </div>
                </div>

                <!-- ëª¨ë‹¬ ë°”ë”” -->
                <div class="modal-body">
                    <!-- ë¹„êµ í…Œì´ë¸” ì»¨í…Œì´ë„ˆ -->
                    <div class="compare-table-container">
                        <table class="compare-table" id="compareTable">
                            <thead>
                                <tr>
                                    <th class="table-header-label">êµ¬ë¶„</th>
                                    <!-- í€ë“œ ì»¬ëŸ¼ë“¤ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                                </tr>
                            </thead>
                            <tbody id="compareTableBody">
                                <!-- ë¹„êµ ë°ì´í„°ê°€ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                            </tbody>
                        </table>
                    </div>

                    <!-- ë¶„ì„ ì½˜í…ì¸  ì˜ì—­ -->
                    <div
                        class="aiAnaylseContainer"
                        id="aiAnaylseContainer"
                    ></div>

                    <!-- ëª¨ë‹¬ ë²„íŠ¼ ì˜ì—­ -->
                    <div class="modal-actions">
                        <button
                            class="modal-btn modal-btn-secondary"
                            id="aiAnalyseBtn"
                        >
                            AI ë¶„ì„
                        </button>
                        <button
                            class="modal-btn modal-btn-primary"
                            id="modalCloseBtn2"
                        >
                            í™•ì¸
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- í‘¸í„° ì˜ì—­ -->
        <th:block th:replace="fragments/footer :: siteFooter"></th:block>
    </body>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let currentPage = 1; // í˜„ì¬ ë¡œë”©í•  í˜ì´ì§€ ë²ˆí˜¸ë¥¼ ì €ì¥
        let pageSize = 10; // í˜ì´ì§€ì˜ ìµœëŒ€ ìš”ì²­ ê°¯ìˆ˜
        let isLoading = false; // í˜„ì¬ API í˜¸ì¶œ ì¤‘ì¸ì§€ ìƒíƒœë¥¼ ë‚˜íƒ€ë‚´ëŠ” í”Œë˜ê·¸
        let hasMoreData = true; // ë” ê°€ì ¸ì˜¬ ë°ì´í„°ê°€ ìˆëŠ”ì§€ ì—¬ë¶€ë¥¼ ë‚˜íƒ€ë‚´ëŠ” í”Œë˜ê·¸
        let investType = null; // ì‚¬ìš©ìì˜ íˆ¬ì ì„±í–¥ íƒ€ì… ë²ˆí˜¸ë¥¼ ì €ì¥
        let investTypeName = ""; // íˆ¬ì ì„±í–¥ íƒ€ì…ì˜ í•œê¸€ ì´ë¦„ì„ ì €ì¥
        let currentFilters = ""; // í˜„ì¬ í•„í„°

        const selectedFunds = [];
        const MAX_COMPARE_COUNT = 3;

        // ê°ì²´
        const loading = document.getElementById("loading");

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        // HTML ë¬¸ì„œê°€ ì™„ì „íˆ ë¡œë“œëœ í›„ ì´ˆê¸°í™” ì‘ì—… ìˆ˜í–‰
        document.addEventListener("DOMContentLoaded", function () {
            // Thymeleafì—ì„œ ì „ë‹¬ëœ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            // ë©”íƒ€ íƒœê·¸ ê²€ìƒ‰: document.querySelector()ë¡œ HTMLì˜ ë©”íƒ€ íƒœê·¸ì—ì„œ íˆ¬ì ì„±í–¥ ì •ë³´ ì°¾ê¸°
            const investTypeElement = document.querySelector(
                'meta[name="invest-type"]'
            );
            const userIdElement = document.querySelector(
                'meta[name="user-id"]'
            );

            // ë°ì´í„° íŒŒì‹±: parseInt()ë¡œ ë¬¸ìì—´ì„ ìˆ«ìë¡œ ë³€í™˜í•˜ì—¬ investType ë³€ìˆ˜ì— ì €ì¥
            if (investTypeElement) {
                investType = parseInt(
                    investTypeElement.getAttribute("content")
                );
            }

            // í•„í„° ì´ˆê¸°í™”
            currentFilters = "";

            // íˆ¬ì ì„±í–¥ ì •ë³´ ì„¤ì •
            // setInvestTypeInfo() í˜¸ì¶œë¡œ í™”ë©´ì— í‘œì‹œí•  íˆ¬ì ì„±í–¥ ì´ë¦„ ì„¤ì •
            setInvestTypeInfo();

            // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
            // loadMoreFunds() í˜¸ì¶œë¡œ ì²« ë²ˆì§¸ í˜ì´ì§€ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            loadMoreFunds();
        });

        // ë” ë§ì€ í€ë“œ ë¡œë“œ
        // ì„œë²„ì—ì„œ í€ë“œ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ í™”ë©´ì— ì¶”ê°€í•˜ëŠ” í•µì‹¬ í•¨ìˆ˜
        async function loadMoreFunds() {
            // ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€
            if (isLoading || !hasMoreData) return;

            // ë¡œë”© ìƒíƒœ ì„¤ì •
            isLoading = true;
            showLoading(isLoading);
            updateLoadMoreButton();

            // ì²« í˜ì´ì§€ ë¡œë“œì¸ì§€ í™•ì¸
            const isFirstLoad = currentPage === 1;

            try {
                // íŒŒë¼ë¯¸í„°
                let apiUrl = `/api/funds/list?page=${currentPage}&limit=${pageSize}&investType=${investType}`;

                // í•„í„° íŒŒë¼ë¯¸í„°ê°€ ìˆìœ¼ë©´ ì¶”ê°€
                if (currentFilters) {
                    apiUrl += `&${currentFilters}`;
                }

                console.log("API ìš”ì²­ URL:", apiUrl); // ë””ë²„ê¹…ìš©

                // API í˜¸ì¶œ
                const response = await fetch(apiUrl);
                const data = await response.json();

                if (data.success) {
                    // ì„±ê³µ ì‹œ ë°ì´í„° ì²˜ë¦¬
                    const funds = data.data.funds;
                    const pagination = data.pagination;

                    console.log("======= ã…‹ã…‹ =======");
                    console.log(funds);
                    console.log(pagination);
                    console.log("======= ã…‹ã…‹ =======");

                    // í€ë“œ ëª©ë¡ ë Œë”ë§
                    renderFunds(funds);

                    // ê²°ê³¼ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸ (ì²« ë¡œë“œì¼ ë•Œë§Œ)
                    if (isFirstLoad) {
                        updateResultMessage(pagination.total, true);
                    }

                    // í˜ì´ì§€ ì •ë³´ ì—…ë°ì´íŠ¸
                    currentPage++;
                    hasMoreData = pagination.hasNext;

                    // ë”ë³´ê¸° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                    const loadMoreBtn =
                        document.getElementById("load-more-btn");

                    if (!hasMoreData) {
                        loadMoreBtn.style.display = "none";
                    } else {
                        loadMoreBtn.style.display = "block";
                    }

                    // ì—ëŸ¬ ë©”ì‹œì§€ ì œê±°
                    // clearErrorMessage();
                    console.log("í€ë“œ ë°ì´í„° ê°–ê³  ì˜´");
                } else {
                    console.log("í€ë“œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤");
                    if (isFirstLoad) {
                        updateResultMessage(0, true);
                    }
                    // ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ì²˜ë¦¬
                    // showErrorMessage(
                    //     data.message ||
                    //         "í€ë“œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
                    // );
                }
            } catch (error) {
                // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ì²˜ë¦¬
                console.error("í€ë“œ ë¡œë“œ ì˜¤ë¥˜:", error);
                if (isFirstLoad) {
                    updateResultMessage(0, true);
                }
                // showErrorMessage(
                //     "ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."
                // );
            } finally {
                // ë¡œë”© ìƒíƒœ í•´ì œ
                isLoading = false;
                showLoading(isLoading);
                updateLoadMoreButton();
            }
        }

        // í€ë“œ ëª©ë¡ ë Œë”ë§
        // í€ë“œ ë°°ì—´ì„ ë°›ì•„ì„œ í™”ë©´ì— ë Œë”ë§
        function renderFunds(funds) {
            // í€ë“œ ëª©ë¡ì„ ë‹´ì„ ì»¨í…Œì´ë„ˆ ìš”ì†Œ ì°¾ê¸°
            const fundList = document.getElementById("fund-list");

            funds.forEach((fund) => {
                // ê° í€ë“œì˜ HTML ìš”ì†Œ ìƒì„±
                const fundElement = createFundElement(fund);

                // ì´ë¯¸ ì„ íƒëœ í€ë“œì¸ì§€ í™•ì¸í•˜ê³  ìƒíƒœ ë³µì›
                restoreSelectionState(fundElement, fund.fundId);

                // ìƒì„±ëœ ìš”ì†Œë¥¼ ì»¨í…Œì´ë„ˆì— ì¶”ê°€
                fundList.appendChild(fundElement);
            });
        }

        // ì„ íƒ ìƒíƒœ ë³µì› í•¨ìˆ˜
        function restoreSelectionState(fundElement, fundId) {
            const isSelected = selectedFunds.some(
                (selectedFund) => selectedFund.id == fundId
            );

            if (isSelected) {
                fundElement.classList.add("selected");
                const compareBtn =
                    fundElement.querySelector(".compare-add-btn");
                if (compareBtn) {
                    compareBtn.classList.add("selected");
                    compareBtn.textContent = "ì„ íƒë¨";
                }
            }
        }

        // í€ë“œ ìš”ì†Œ ìƒì„±
        // ê°œë³„ í€ë“œ ë°ì´í„°ë¥¼ HTML ìš”ì†Œë¡œ ë³€í™˜
        function createFundElement(fund) {
            const fundDiv = document.createElement("div");
            fundDiv.className = "fund-item";
            fundDiv.setAttribute("data-id", fund.fundId);

            // ìˆ˜ìµë¥  í´ë˜ìŠ¤ ê²°ì • í•¨ìˆ˜
            const getReturnClass = (value) => {
                if (value === null || value === undefined) return "";
                // return value >= 0 ? "pos" : "neg";
                if (value > 0) {
                    return "pos";
                } else if (value < 0) {
                    return "neg";
                } else {
                    return "zero";
                }
            };

            // ìˆ˜ìµë¥  í¬ë§·íŒ… í•¨ìˆ˜
            const formatReturn = (value) => {
                if (value === null || value === undefined) return "0.00%";
                return `${value.toFixed(2)}%`;
            };

            // ìˆ«ì í¬ë§·íŒ… í•¨ìˆ˜
            const formatNumber = (value) => {
                if (value === null || value === undefined) return "0";
                return value.toLocaleString();
            };

            // ë‚ ì§œ í¬ë§·íŒ… í•¨ìˆ˜
            const formatDate = (dateStr) => {
                if (!dateStr) return "";
                // LocalDateëŠ” "YYYY-MM-DD" í˜•íƒœë¡œ ì˜¤ë¯€ë¡œ "-"ë¥¼ "."ë¡œ ë³€ê²½
                return dateStr.replace(/-/g, ".");
            };

            // ìœ„í—˜ë“±ê¸‰ í´ë˜ìŠ¤ ê²°ì •
            const getRiskClass = (riskLevel) => {
                return `risk-${riskLevel}`;
            };

            // íˆ¬ìì§€ì—­ ë°°ì§€ ìƒì„± í•¨ìˆ˜
            const createRegionBadge = (region) => {
                return region && region.trim() !== ""
                    ? `<span class="badge region">${region}</span>`
                    : "";
            };

            // ìœ„í—˜ë“±ê¸‰ í…ìŠ¤íŠ¸ ê²°ì •
            const getRiskText = (riskLevel) => {
                const riskTexts = {
                    1: "ë§¤ìš°ë†’ì€ìœ„í—˜(1ë“±ê¸‰)",
                    2: "ë†’ì€ìœ„í—˜(2ë“±ê¸‰)",
                    3: "ë‹¤ì†Œë†’ì€ìœ„í—˜(3ë“±ê¸‰)",
                    4: "ë³´í†µìœ„í—˜(4ë“±ê¸‰)",
                    5: "ë‚®ì€ìœ„í—˜(5ë“±ê¸‰)",
                    6: "ë§¤ìš°ë‚®ì€ìœ„í—˜(6ë“±ê¸‰)",
                };
                return riskTexts[riskLevel] || `ìœ„í—˜ë“±ê¸‰(${riskLevel}ë“±ê¸‰)`;
            };

            fundDiv.innerHTML = `
                    <!-- ë©”íƒ€ ë°ì´í„° -->
                    <section class="fund-item-section fund-meta">
                        <div class="fund-name-container">
                            <h3 class="fund-name">
                                <a href="/fund/${
                                    fund.fundId
                                }" class="fund-name-link">
                                    ${fund.fundName || ""}
                                </a>
                            </h3>
                        </div>
                        <ul class="fund-detail">
                            <li>ì„¤ì •ì¼&nbsp;${formatDate(
                                fund.establishDate
                            )}</li>
                            <li>ê¸°ì¤€ê°€&nbsp;${formatNumber(fund.nav)}</li>
                            <li>ìˆœìì‚°&nbsp;${fund.aum || 0}ì–µ</li>
                        </ul>
                        <div class="badge-list">
                            <span class="badge company">${
                                fund.managementCompany || ""
                            }</span>
                            <span class="badge type">${
                                fund.fundType || ""
                            }</span>
                            ${createRegionBadge(fund.investmentRegion)}
                            <span class="badge risk ${getRiskClass(
                                fund.riskLevel
                            )}">
                                ${getRiskText(fund.riskLevel)}
                            </span>
                        </div>
                        <div class="fund-item-section fund-compare-check">
                            <button class="compare-add-btn"
                                    data-fund-id="${fund.fundId}"
                                    data-fund-name="${fund.fundName || ""}">
                                ë¹„êµë‹´ê¸°
                            </button>
                        </div>
                    </section>

                    <!-- ìˆ˜ìµë¥  -->
                    <section class="fund-item-section fund-return">
                        <div class="stat">
                            <span>1ê°œì›”</span>
                            <strong class="${getReturnClass(
                                fund.return1m
                            )}">${formatReturn(fund.return1m)}</strong>
                        </div>
                        <div class="stat">
                            <span>3ê°œì›”</span>
                            <strong class="${getReturnClass(
                                fund.return3m
                            )}">${formatReturn(fund.return3m)}</strong>
                        </div>
                        <div class="stat">
                            <span>6ê°œì›”</span>
                            <strong class="${getReturnClass(
                                fund.return6m
                            )}">${formatReturn(fund.return6m)}</strong>
                        </div>
                        <div class="stat">
                            <span>12ê°œì›”</span>
                            <strong class="${getReturnClass(
                                fund.return12m
                            )}">${formatReturn(fund.return12m)}</strong>
                        </div>
                        <div class="stat">
                            <span>ëˆ„ì </span>
                            <strong class="${getReturnClass(
                                fund.returnSince
                            )}">${formatReturn(fund.returnSince)}</strong>
                        </div>
                    </section>
                `;
            return fundDiv;
        }

        // ìˆ«ì í¬ë§·íŒ…
        function formatNumber(number) {
            return new Intl.NumberFormat("ko-KR").format(number);
        }

        function formatDate(date) {
            if (!(date instanceof Date) || isNaN(date)) return "";

            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, "0");
            const d = String(date.getDate()).padStart(2, "0");

            return `${y}-${m}-${d}`;
        }

        // ë¡œë”© ìƒíƒœ í‘œì‹œ
        function showLoading(show) {
            const loading = document.getElementById("loading");
            if (loading) {
                loading.classList.toggle("show", show);
            }
        }

        // ë”ë³´ê¸° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateLoadMoreButton() {
            const loadMoreBtn = document.getElementById("load-more-btn");
            loadMoreBtn.disabled = isLoading;
            loadMoreBtn.textContent = isLoading ? "ë¡œë”© ì¤‘..." : "ë”ë³´ê¸°";
        }

        // ê²€ìƒ‰ ë©”ì„¸ì§€ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateResultMessage(totalCount, isFirstLoad = false) {
            const messageElement = document.querySelector(".message");

            if (!messageElement) return;

            console.log("!! : " + isFirstLoad);
            console.log("!! : " + totalCount);

            if (isFirstLoad) {
                messageElement.innerHTML = `
                                <div class="result-summary">
                                    <span class="result-count">ì´ <strong>${totalCount.toLocaleString()}</strong>ê°œì˜ í€ë“œë¥¼ ì¡°íšŒí–ˆìŠµë‹ˆë‹¤.</span>
                                </div>
                            `;
                messageElement.classList.add("show");
            } else {
                messageElement.classList.remove("show");
            }
        }

        function setInvestTypeInfo() {
            const investTypeNames = {
                1: "ì•ˆì •í˜•",
                2: "ì•ˆì • ì¶”êµ¬í˜•",
                3: "ìœ„í—˜ ì¤‘ë¦½í˜•",
                4: "ì ê·¹ íˆ¬ìí˜•",
                5: "ê³µê²© íˆ¬ìí˜•",
            };

            investTypeName = investTypeNames[investType] || "ì•Œ ìˆ˜ ì—†ìŒ";

            // íˆ¬ìì„±í–¥ ìš”ì†Œ ê°€ì ¸ì˜´
            const investTypeElement = document.getElementById("invest-type");
            if (investTypeElement) {
                // í…ìŠ¤íŠ¸ ì„¤ì •
                investTypeElement.textContent = investTypeName;

                // ê¸°ì¡´ í´ë˜ìŠ¤ ì œê±°
                investTypeElement.className = "";

                // íˆ¬ìì„±í–¥ì— ë§ëŠ” í´ë˜ìŠ¤ ì¶”ê°€
                if (investType >= 1 && investType <= 5) {
                    investTypeElement.classList.add(
                        `invest-type-${investType}`
                    );
                }
            }
        }

        // ë©”ì‹œì§€ ì˜ì—­ì„ ë³´ì¡´í•˜ë©´ì„œ í€ë“œ ì•„ì´í…œë§Œ ì‚­ì œí•˜ëŠ” í•¨ìˆ˜
        function clearFundItems() {
            const fundList = document.getElementById("fund-list");
            const messageElement = fundList.querySelector(".message");

            // ë©”ì‹œì§€ ì˜ì—­ ì„ì‹œ ì €ì¥
            let messageHTML = "";
            if (messageElement) {
                messageHTML = messageElement.outerHTML;
            }

            // ì „ì²´ í´ë¦¬ì–´
            fundList.innerHTML = "";

            // ë©”ì‹œì§€ ì˜ì—­ë§Œ ë‹¤ì‹œ ì¶”ê°€
            if (messageHTML) {
                fundList.insertAdjacentHTML("afterbegin", messageHTML);
            }
        }

        // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì‹œ - ìˆ˜ì •í•„ìš”
        document
            .getElementById("fundForm")
            .addEventListener("submit", function (e) {
                e.preventDefault();

                // FormDataë¡œ ì²´í¬ëœ ê°’ë“¤ ìˆ˜ì§‘
                const formData = new FormData(
                    document.getElementById("fundForm")
                );
                const params = new URLSearchParams();

                // ì²´í¬ëœ ê°’ë“¤ì„ URLSearchParamsì— ì¶”ê°€
                for (let [key, value] of formData.entries()) {
                    params.append(key, value);
                }

                // ì „ì—­ ë³€ìˆ˜ì— í•„í„° íŒŒë¼ë¯¸í„° ì €ì¥
                currentFilters = params.toString();

                console.log("ì ìš©ëœ í•„í„°:", currentFilters); // ë””ë²„ê¹…ìš©

                // í˜ì´ì§€ ì´ˆê¸°í™”
                currentPage = 1;
                hasMoreData = true;

                // ê¸°ì¡´ ê²°ê³¼ í´ë¦¬ì–´
                // document.getElementById("fund-list").innerHTML = "";
                clearFundListKeepSelection();

                // ë©”ì‹œì§€ ì˜ì—­ë§Œ ë³´ì¡´í•˜ê³  í€ë“œ ì•„ì´í…œë“¤ë§Œ ì‚­ì œ
                // clearFundItems();

                // ìƒˆë¡œìš´ ê²€ìƒ‰ ì‹¤í–‰
                loadMoreFunds(); // ì´ë•Œ isFirstLoad = trueê°€ ë¨
            });

        // í•„í„° ê²€ìƒ‰ ì‹œ í˜¸ì¶œí•  í•¨ìˆ˜ (ê¸°ì¡´ submit ì´ë²¤íŠ¸ì— ì¶”ê°€)
        function clearFundListKeepSelection() {
            // ê¸°ì¡´ ê²°ê³¼ëŠ” í´ë¦¬ì–´í•˜ë˜, ì„ íƒëœ í€ë“œ ìƒíƒœëŠ” ìœ ì§€
            document.getElementById("fund-list").innerHTML = "";

            // ë¹„êµë°”ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€ (selectedFunds ë°°ì—´ì€ ê±´ë“œë¦¬ì§€ ì•ŠìŒ)
            // updateCompareBar(); // ì´ë¯¸ ì„ íƒëœ ìƒíƒœì´ë¯€ë¡œ í˜¸ì¶œ í•„ìš” ì—†ìŒ
        }

        // ë¹„êµë‹´ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        document.addEventListener("click", function (e) {
            if (e.target.classList.contains("compare-add-btn")) {
                const fundId = e.target.dataset.fundId;
                const fundName = e.target.dataset.fundName;
                const fundItem = e.target.closest(".fund-item");

                toggleFundSelection(fundId, fundName, fundItem, e.target);
            }
        });

        // í€ë“œ ì„ íƒ/í•´ì œ í† ê¸€
        function toggleFundSelection(fundId, fundName, fundItem, button) {
            const existingIndex = selectedFunds.findIndex(
                (f) => f.id === fundId
            );

            if (existingIndex > -1) {
                // ì„ íƒ í•´ì œ
                selectedFunds.splice(existingIndex, 1);
                fundItem.classList.remove("selected");
                button.classList.remove("selected");
                button.textContent = "ë¹„êµë‹´ê¸°";
            } else {
                // ìƒˆë¡œ ì„ íƒ
                if (selectedFunds.length >= MAX_COMPARE_COUNT) {
                    alert(`ìµœëŒ€ ${MAX_COMPARE_COUNT}ê°œê¹Œì§€ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
                    return;
                }

                selectedFunds.push({
                    id: fundId,
                    name: fundName,
                    // ë‚˜ì¤‘ì— í•„ìš”í•œ ì¶”ê°€ ë°ì´í„°ë“¤...
                });
                fundItem.classList.add("selected");
                button.classList.add("selected");
                button.textContent = "ì„ íƒë¨";
            }

            updateCompareBar();
        }

        // ë¹„êµë°” ì—…ë°ì´íŠ¸
        function updateCompareBar() {
            const compareBar = document.getElementById("compareBar");
            const compareCount = document.getElementById("compareCount");
            const fundsPreview = document.getElementById("fundsPreview");
            const compareBtn = document.getElementById("compareBtn");

            if (selectedFunds.length > 0) {
                compareBar.classList.add("show");
                compareCount.textContent = `${selectedFunds.length}ê°œ ì„ íƒ`;

                fundsPreview.innerHTML = selectedFunds
                    .map(
                        (fund, index) => `
                                <div class="fund-preview">
                                    <div class="fund-preview-name">${fund.name}</div>
                                    <button class="fund-remove-btn" onclick="removeFund(${index})" title="ì œê±°">Ã—</button>
                                </div>
                            `
                    )
                    .join("");

                compareBtn.disabled = selectedFunds.length < 2;
            } else {
                compareBar.classList.remove("show");
            }
        }

        // ê°œë³„ í€ë“œ ì œê±°
        function removeFund(index) {
            const fund = selectedFunds[index];
            selectedFunds.splice(index, 1);

            // í•´ë‹¹ í€ë“œ ì•„ì´í…œì˜ ì„ íƒ ìƒíƒœ í•´ì œ
            const fundItem = document.querySelector(`[data-id="${fund.id}"]`);
            if (fundItem) {
                fundItem.classList.remove("selected");
                const btn = fundItem.querySelector(".compare-add-btn");
                btn.classList.remove("selected");
                btn.textContent = "ë¹„êµë‹´ê¸°";
            }

            updateCompareBar();
        }

        // ì „ì²´ í•´ì œ
        document
            .getElementById("clearAllBtn")
            .addEventListener("click", function () {
                selectedFunds.forEach((fund) => {
                    const fundItem = document.querySelector(
                        `[data-id="${fund.id}"]`
                    );
                    if (fundItem) {
                        fundItem.classList.remove("selected");
                        const btn = fundItem.querySelector(".compare-add-btn");
                        btn.classList.remove("selected");
                        btn.textContent = "ë¹„êµë‹´ê¸°";
                    }
                });

                selectedFunds.length = 0;
                updateCompareBar();
            });

        // ë¹„êµí•˜ê¸° ë²„íŠ¼ í´ë¦­
        document
            .getElementById("compareBtn")
            .addEventListener("click", function () {
                if (selectedFunds.length >= 2) {
                    // console.log("ë¹„êµí•  í€ë“œë“¤:", selectedFunds);
                    // alert("ë¹„êµ ëª¨ë‹¬ì„ ì—¬ëŠ” ê¸°ëŠ¥ (ë‹¤ìŒ ë‹¨ê³„ì—ì„œ êµ¬í˜„)");
                    // ì—¬ê¸°ì„œ ë¹„êµ ëª¨ë‹¬ì„ ì—´ê±°ë‚˜ ë¹„êµ í˜ì´ì§€ë¡œ ì´ë™

                    openCompareModal();
                }
            });

        // ì „ì²´ ì´ˆê¸°í™” í•¨ìˆ˜ (í˜ì´ì§€ ë¡œë“œ ì‹œë‚˜ ì™„ì „ ì´ˆê¸°í™”ê°€ í•„ìš”í•  ë•Œ)
        function resetAllSelections() {
            selectedFunds.length = 0;
            updateCompareBar();

            // ëª¨ë“  í€ë“œ ì•„ì´í…œì˜ ì„ íƒ ìƒíƒœ í•´ì œ
            document.querySelectorAll(".fund-item.selected").forEach((item) => {
                item.classList.remove("selected");
                const btn = item.querySelector(".compare-add-btn");
                if (btn) {
                    btn.classList.remove("selected");
                    btn.textContent = "ë¹„êµë‹´ê¸°";
                }
            });
        }

        // ì„ íƒëœ í€ë“œ ê°œìˆ˜ê°€ ìµœëŒ€ì¹˜ì— ë„ë‹¬í–ˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
        function isMaxSelectionReached() {
            return selectedFunds.length >= MAX_COMPARE_COUNT;
        }

        // í˜„ì¬ ì„ íƒëœ í€ë“œ ID ëª©ë¡ ë°˜í™˜
        function getSelectedFundIds() {
            return selectedFunds.map((fund) => fund.id);
        }

        // ë¹„êµ ëª¨ë‹¬ ì—´ê¸°
        function openCompareModal() {
            if (selectedFunds.length < 2) {
                alert("ìµœì†Œ 2ê°œ ì´ìƒì˜ í€ë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }

            const modal = document.getElementById("compareModal");
            modal.classList.add("show");

            // ëª¨ë‹¬ ë‚´ìš© ìƒì„±
            renderCompareModal();

            // ìŠ¤í¬ë¡¤ ë°©ì§€
            document.body.style.overflow = "hidden";
        }

        // ë¹„êµ ëª¨ë‹¬ ë‹«ê¸°
        function closeCompareModal() {
            const modal = document.getElementById("compareModal");
            modal.classList.remove("show");

            // AI ë¶„ì„ ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™”
            const aiAnaylseContainer =
                document.getElementById("aiAnaylseContainer");
            if (aiAnaylseContainer) {
                aiAnaylseContainer.innerHTML = "";
            }

            // ìŠ¤í¬ë¡¤ ë³µì›
            document.body.style.overflow = "auto";
        }

        // ë¹„êµ ëª¨ë‹¬ ë‚´ìš© ë Œë”ë§
        function renderCompareModal() {
            //updateCompareSummary();
            renderCompareTable();

            // ì°¨íŠ¸ê°€ í•„ìš”í•œ ê²½ìš°
            // renderReturnsChart();
        }

        // ë¹„êµ ìš”ì•½ ì—…ë°ì´íŠ¸
        /*
                    function updateCompareSummary() {
                        const summaryText =
                            document.getElementById("compareSummaryText");
                        summaryText.textContent = `${selectedFunds.length}ê°œ í€ë“œ ë¹„êµ`;
                    }
                    */

        // ë¹„êµ í…Œì´ë¸” ë Œë”ë§
        function renderCompareTable() {
            const table = document.getElementById("compareTable");
            const tbody = document.getElementById("compareTableBody");

            // í…Œì´ë¸” í—¤ë” ìƒì„±
            renderTableHeader(table, selectedFunds);

            // í…Œì´ë¸” ë°”ë”” ìƒì„±
            renderTableBody(tbody, selectedFunds);
        }

        // í…Œì´ë¸” í—¤ë” ë Œë”ë§
        function renderTableHeader(table, funds) {
            const thead = table.querySelector("thead tr");

            // ê¸°ì¡´ í€ë“œ ì»¬ëŸ¼ ì œê±° (ì²« ë²ˆì§¸ thëŠ” ìœ ì§€)
            const existingHeaders = thead.querySelectorAll(
                "th:not(.table-header-label)"
            );
            existingHeaders.forEach((th) => th.remove());

            // í€ë“œë³„ í—¤ë” ì¶”ê°€
            funds.forEach((fund, index) => {
                const th = document.createElement("th");
                th.className = "fund-header-cell";
                th.innerHTML = `
                        <span class="fund-header-name">${truncateText(
                            fund.name,
                            50
                        )}</span>
                `;
                thead.appendChild(th);
            });
        }

        // í…Œì´ë¸” ë°”ë”” ë Œë”ë§
        function renderTableBody(tbody, funds) {
            tbody.innerHTML = "";
            // ë¹„êµí•  í•­ëª©ë“¤ ì •ì˜
            const compareItems = [
                {
                    label: "í€ë“œìœ í˜•",
                    key: "fundType",
                    formatter: (value) =>
                        `<div class="data-main">${value}</div>`,
                },
                {
                    label: "íˆ¬ìì§€ì—­",
                    key: "region",
                    formatter: (value) =>
                        `<div class="data-main">${value || "-"}</div>`,
                },
                {
                    label: "ìœ„í—˜ë“±ê¸‰",
                    key: "riskLevel",
                    formatter: (value) =>
                        `<span class="data-main">${getRiskText(
                            value || 4
                        )}</span>`,
                },
                {
                    label: "ìš´ìš©ì‚¬",
                    key: "managementCompany",
                    formatter: (value) =>
                        `<div class="data-main">${value || "-"}</div>`,
                },
                {
                    label: "ê¸°ì¤€ê°€",
                    key: "nav",
                    formatter: (value) => `
                                <div class="data-main">${formatNumber(
                                    value
                                )}ì›</div>
                            `,
                },
                {
                    label: "ìˆœìì‚°",
                    key: "aum",
                    formatter: (value) =>
                        `<div class="data-main">${value || "-"}ì–µì›</div>`,
                },
                {
                    label: "3ê°œì›” ìˆ˜ìµë¥ ",
                    key: "return3m",
                    formatter: (value) => formatReturnCell(value),
                },
                {
                    label: "12ê°œì›” ìˆ˜ìµë¥ ",
                    key: "return12m",
                    formatter: (value) => formatReturnCell(value),
                },
            ];

            // ê° ë¹„êµ í•­ëª©ë³„ë¡œ í–‰ ìƒì„±
            compareItems.forEach((item) => {
                const tr = document.createElement("tr");

                // ë¼ë²¨ ì…€
                const labelTd = document.createElement("td");
                labelTd.className = "row-label";
                labelTd.textContent = item.label;
                tr.appendChild(labelTd);

                // ê° í€ë“œë³„ ë°ì´í„° ì…€
                funds.forEach((fund) => {
                    const dataTd = document.createElement("td");
                    dataTd.className = "fund-data-cell";

                    // ì‹¤ì œ í€ë“œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (í˜„ì¬ëŠ” selectedFundsì— ì œí•œëœ ì •ë³´ë§Œ ìˆìŒ)
                    const fundData = getFundDataById(fund.id);
                    const value = fundData
                        ? fundData[item.key]
                        : fund[item.key] || null;

                    dataTd.innerHTML = item.formatter(value, fundData || fund);
                    tr.appendChild(dataTd);
                });

                tbody.appendChild(tr);
            });
        }

        // ìˆ˜ìµë¥  ì…€ í¬ë§·íŒ…
        function formatReturnCell(value) {
            if (value === null || value === undefined) {
                return '<div class="data-main return-neutral">-</div>';
            }

            const returnClass =
                value >= 0 ? "return-positive" : "return-negative";
            const sign = value >= 0 ? "+" : "";

            return `<div class="data-main ${returnClass}">${sign}${value.toFixed(
                2
            )}%</div>`;
        }

        // í€ë“œ IDë¡œ ìƒì„¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì‹¤ì œ ë°ì´í„°ì™€ ì—°ë™ í•„ìš”)
        function getFundDataById(fundId) {
            // í˜„ì¬ í˜ì´ì§€ì— ë¡œë“œëœ í€ë“œë“¤ì—ì„œ ì°¾ê¸°
            const fundElements = document.querySelectorAll(".fund-item");
            for (let element of fundElements) {
                if (element.dataset.id == fundId) {
                    return extractFundDataFromElement(element);
                }
            }
            return null;
        }

        // DOM ìš”ì†Œì—ì„œ í€ë“œ ë°ì´í„° ì¶”ì¶œ
        function extractFundDataFromElement(element) {
            const fundName =
                element.querySelector(".fund-name")?.textContent || "";
            const badges = element.querySelectorAll(".badge");
            const stats = element.querySelectorAll(".stat strong");
            const details = element.querySelectorAll(".fund-detail li");

            // ê¸°ë³¸ ì •ë³´ ì¶”ì¶œ
            let managementCompany = "",
                fundType = "",
                region = "",
                riskLevel = 4;
            badges.forEach((badge) => {
                if (badge.classList.contains("company"))
                    managementCompany = badge.textContent;
                if (badge.classList.contains("type"))
                    fundType = badge.textContent;
                if (badge.classList.contains("region"))
                    region = badge.textContent;
                if (badge.classList.contains("risk")) {
                    const riskMatch = badge.className.match(/risk-(\d+)/);
                    if (riskMatch) riskLevel = parseInt(riskMatch[1]);
                }
            });

            // ìˆ˜ìµë¥  ì •ë³´ ì¶”ì¶œ
            const returns = Array.from(stats).map((stat) => {
                const text = stat.textContent.replace("%", "");
                return parseFloat(text) || 0;
            });

            // ìƒì„¸ ì •ë³´ ì¶”ì¶œ
            let establishDate = "",
                nav = "",
                aum = "";
            details.forEach((detail) => {
                const text = detail.textContent;
                if (text.includes("ì„¤ì •ì¼"))
                    establishDate = text.replace("ì„¤ì •ì¼\u00A0", "");
                if (text.includes("ê¸°ì¤€ê°€"))
                    nav = text.replace("ê¸°ì¤€ê°€\u00A0", "").replace(",", "");
                if (text.includes("ìˆœìì‚°"))
                    aum = text.replace("ìˆœìì‚°\u00A0", "").replace("ì–µ", "");
            });

            return {
                name: fundName,
                managementCompany,
                fundType,
                region,
                riskLevel,
                establishDate,
                nav: parseFloat(nav) || 0,
                aum: parseInt(aum) || 0,
                return1m: returns[0] || 0,
                return3m: returns[1] || 0,
                return6m: returns[2] || 0,
                return12m: returns[3] || 0,
                returnSince: returns[4] || 0,
            };
        }

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        function truncateText(text, maxLength) {
            if (!text) return "-";
            return text.length > maxLength
                ? text.substring(0, maxLength) + "..."
                : text;
        }

        function getFundTypeFromName(name) {
            if (!name) return "-";
            return name;
        }

        function getRiskText(riskLevel) {
            const riskTexts = {
                1: "ë§¤ìš°ë†’ì€ìœ„í—˜(1ë“±ê¸‰)",
                2: "ë†’ì€ìœ„í—˜(2ë“±ê¸‰)",
                3: "ë‹¤ì†Œë†’ì€ìœ„í—˜(3ë“±ê¸‰)",
                4: "ë³´í†µìœ„í—˜(4ë“±ê¸‰)",
                5: "ë‚®ì€ìœ„í—˜(5ë“±ê¸‰)",
                6: "ë§¤ìš°ë‚®ì€ìœ„í—˜(6ë“±ê¸‰)",
            };
            return riskTexts[riskLevel] || `ìœ„í—˜ë“±ê¸‰(${riskLevel}ë“±ê¸‰)`;
        }

        // ëª¨ë‹¬ ë‹«ê¸° ì´ë²¤íŠ¸ë“¤
        document
            .getElementById("modalCloseBtn")
            .addEventListener("click", closeCompareModal);
        document
            .getElementById("modalCloseBtn2")
            .addEventListener("click", closeCompareModal);

        // ëª¨ë‹¬ ì˜¤ë²„ë ˆì´ í´ë¦­ ì‹œ ë‹«ê¸°
        document
            .getElementById("compareModal")
            .addEventListener("click", function (e) {
                if (e.target === this) {
                    closeCompareModal();
                }
            });

        // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
        document.addEventListener("keydown", function (e) {
            if (e.key === "Escape") {
                const modal = document.getElementById("compareModal");
                if (modal.classList.contains("show")) {
                    closeCompareModal();
                }
            }
        });

        // AI ë¶„ì„ ë²„íŠ¼
        document
            .getElementById("aiAnalyseBtn")
            .addEventListener("click", function (e) {
                // ì„ íƒëœ í€ë“œê°€ ìˆëŠ”ì§€ í™•ì¸
                if (!selectedFunds || selectedFunds.length === 0) {
                    alert("ë¶„ì„í•  í€ë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                    return;
                }

                // selectedFundsì—ì„œ ID ì¶”ì¶œ
                const fundIds = selectedFunds.map((fund) => fund.id);

                // URL íŒŒë¼ë¯¸í„° ìƒì„±
                const params = new URLSearchParams();

                // fundId íŒŒë¼ë¯¸í„°ë¥¼ ì—¬ëŸ¬ ê°œ ì¶”ê°€ (List<Long> ì²˜ë¦¬)
                fundIds.forEach((id) => {
                    params.append("fundId", id);
                });

                // invert íŒŒë¼ë¯¸í„° ì¶”ê°€
                params.append("invert", investType);

                // ìµœì¢… URL ìƒì„±
                const url = `/ai/compare?${params.toString()}`;
                // console.log("AI ë¶„ì„ ìš”ì²­ URL:", url);

                // AI ë¶„ì„ ì»¨í…ì¸  ìš”ì†Œ ì°¾ê¸°
                const aiAnaylseContainer =
                    document.getElementById("aiAnaylseContainer");

                if (!aiAnaylseContainer) {
                    console.error(
                        "aiAnaylseContainer ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
                    );
                    return;
                }

                // ë¡œë”© í‘œì‹œ
                aiAnaylseContainer.innerHTML = `
                            <div class="loading-analyse-container">
                                <div class="loading-analyse-spinner"></div>
                                <p>AIê°€ í€ë“œë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                            </div>
                        `;

                // AJAX ìš”ì²­
                fetch(url, {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                    },
                })
                    .then((response) => {
                        console.log("ì‘ë‹µ ìƒíƒœ:", response.status);

                        if (!response.ok) {
                            throw new Error(
                                `HTTP error! status: ${response.status}`
                            );
                        }
                        return response.text(); // String ì‘ë‹µì´ë¯€ë¡œ text()ë¡œ ë°›ê¸°
                    })
                    .then((data) => {
                        // console.log("AI ë¶„ì„ ê²°ê³¼:", data);
                        // ì„±ê³µ ì‹œ ë°›ì€ ë°ì´í„°ë¥¼ innerHTMLì— ì„¤ì •
                        aiAnaylseContainer.innerHTML = data;
                    })
                    .catch((error) => {
                        console.error("AI ë¶„ì„ ìš”ì²­ ì‹¤íŒ¨:", error);

                        // ì—ëŸ¬ ì‹œ ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
                        aiAnaylseContainer.innerHTML = `
                                <div class="error-container">
                                    <p>âŒ AI ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
                                    <p>ì˜¤ë¥˜: ${error.message}</p>
                                    <button onclick="aiAnalyseBtn()" class="retry-btn">ë‹¤ì‹œ ì‹œë„</button>
                                </div>
                            `;
                    });
            });

        // í€ë“œ ì¶”ê°€ ë²„íŠ¼ (ëª¨ë‹¬ ë‚´ì—ì„œ)
        /*
                    document
                        .getElementById("addMoreBtn")
                        .addEventListener("click", function () {
                            closeCompareModal();
                            // í•„ìš”ì‹œ í€ë“œ ëª©ë¡ìœ¼ë¡œ ìŠ¤í¬ë¡¤í•˜ê±°ë‚˜ ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ
                            alert("í€ë“œ ëª©ë¡ì—ì„œ ì¶”ê°€í•  í€ë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                        });
                    */

        // ë¹„êµí‘œ ì €ì¥ ê¸°ëŠ¥
        /*
                    document
                        .getElementById("exportBtn")
                        .addEventListener("click", function () {
                            // CSV ë˜ëŠ” ì´ë¯¸ì§€ë¡œ ì €ì¥í•˜ëŠ” ê¸°ëŠ¥ êµ¬í˜„ ê°€ëŠ¥
                            alert("ë¹„êµí‘œ ì €ì¥ ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤.");
                        });
                    */

        // ì¸ì‡„ ê¸°ëŠ¥
        /*
                    document
                        .getElementById("printBtn")
                        .addEventListener("click", function () {
                            window.print();
                        });
                    */

        // function showLoading() {
        //     loading.hidden = false;
        // }
        // function hideLoading() {
        //     loading.hidden = true;
        // }

        // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
        // function showErrorMessage(message) {
        //     const errorContainer =
        //         document.getElementById("errorContainer");
        //     errorContainer.innerHTML = `
        //     <div class="error-message">
        //         ${message}
        //     </div>
        // `;
        // }

        // ì—ëŸ¬ ë©”ì‹œì§€ ì œê±°
        // function clearErrorMessage() {
        //     const errorContainer =
        //         document.getElementById("errorContainer");
        //     errorContainer.innerHTML = "";
        // }

        // ë¬´í•œ ìŠ¤í¬ë¡¤ ì˜µì…˜ (ì„ íƒì‚¬í•­)
        // window.addEventListener('scroll', function() {
        //     if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 1000) {
        //         loadMoreFunds();
        //     }
        // });
    </script>

    <!-- Thymeleaf ë°ì´í„° ì „ë‹¬ì„ ìœ„í•œ ë©”íƒ€ íƒœê·¸ -->
    <meta name="invest-type" th:content="${investType}" />
    <meta name="user-id" th:content="${userId}" />
</html>
