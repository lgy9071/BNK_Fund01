<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ìƒí’ˆ í†µê³„</title>
  <link rel="stylesheet" href="/css/admin/admin_layout.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

  <style>
    .layout { display:flex; flex-direction:column; height:100%; }
    .main-wrapper { display:flex; flex:1; }
    main.content { display:flex; flex-direction:column; gap:22px; flex:1; padding:24px; }

    /* ëŒ€ì‹œë³´ë“œ ê·¸ë¦¬ë“œ */
    .dashboard-grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 18px;
      width: 100%;
      max-width: 1240px;
      margin: 0 auto;
      overflow: auto !important ; 
    }

    /* ì¹´ë“œ ê³µí†µ */
    .card{
      background:#fff;
      border-radius:16px;
      box-shadow:0 6px 20px rgba(0,0,0,0.06);
      padding:18px 20px 22px;
      display:flex; flex-direction:column; min-height:220px;
    }
    .card-header{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px; }
    .card-title{ font-size:18px; font-weight:800; color:#0f3a53; margin:0; }
    .card-toolbar{ display:flex; align-items:center; gap:8px; }
    .card select{
      border:1px solid #d9e2ec; background:#f7fafc; padding:6px 8px; border-radius:8px; font-weight:600;
    }

    /* ì°¨íŠ¸ ìº”ë²„ìŠ¤ ì˜ì—­ */
    .chart-box{ position:relative; height:300px; }
    .chart-box.sm{ height:260px; }
    .empty{
      flex:1; display:flex; align-items:center; justify-content:center; color:#6b7c93; font-weight:600; border:2px dashed #e6eef6; border-radius:12px; padding:18px;
    }

    /* ë¦¬ìŠ¤íŠ¸ */
    .list{ display:flex; flex-direction:column; gap:10px; margin-top:6px; }
    .list-item{
      display:flex; align-items:center; justify-content:space-between; gap:8px;
      padding:7px 10px; border:1px solid #edf2f7; border-radius:12px; background:#fbfdff;
    }
    .rank{ width:28px; height:28px; border-radius:8px; display:inline-flex; align-items:center; justify-content:center; font-weight:800; background:#f3f7fb; }
    .item-name{ font-weight:700; color:#12344d; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .item-metric{ font-weight:800; }

    /* ê·¸ë¦¬ë“œ ë°°ì¹˜ */
    /* lg ì´ìƒ */
    .col-12{ grid-column: span 12; }
    .col-8{ grid-column: span 8; }
    .col-6{ grid-column: span 6; }
    .col-4{ grid-column: span 4; }

    /* ë°˜ì‘í˜• */
    @media (max-width: 1080px){
      .col-8{ grid-column: span 12; }
      .col-6{ grid-column: span 12; }
      .col-4{ grid-column: span 12; }
      .chart-box{ height:280px; }
    }

    .item-text {
      flex: 1 1 auto;
      min-width: 0;                 /* ellipsis ì ìš© */
      display: flex;
      align-items: center;
      justify-content: flex-start;  /* ì™¼ìª½ ì •ë ¬ */
      gap: 6px;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }

    .rank {
      flex: 0 0 28px;
      width: 28px;
      height: 28px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      background: #f3f7fb;

      margin-right: 12px;   /* ìˆ«ìë‘ í…ìŠ¤íŠ¸ ì‚¬ì´ ì—¬ë°± */
    }


      .btn-primary{
    padding:8px 12px;border:none;border-radius:10px;font-weight:800;
    background:#0e7afe;color:#fff;box-shadow:0 6px 16px rgba(14,122,254,.25);
    cursor:pointer;transition:transform .08s ease;
  }
  .btn-primary:active{ transform:translateY(1px); }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body>
<div class="layout">
  <div th:replace="admin/admin_header :: adminHeader"></div>
  <div class="main-wrapper">
    <div th:replace="admin/admin_aside :: adminAside"></div>

    <main class="content">

  <div class="page-toolbar" style="display:flex;justify-content:flex-end;gap:8px;">
    <button id="btnExportPdf" class="btn-primary">PDFë¡œ ì €ì¥</button>
  </div>
<div class="dashboard-grid">

  <!-- (ìœ—ì¤„) 1) ê°€ì…ì íˆ¬ì ì„±í–¥ ë¶„í¬ -->
  <section class="card col-4">
    <div class="card-header">
      <h3 class="card-title">ê°€ì…ì íˆ¬ì ì„±í–¥ ë¶„í¬</h3>
    </div>
    <div class="chart-box sm" id="profileBox">
      <canvas id="profileChart"></canvas>
    </div>
  </section>

  <!-- (ìœ—ì¤„) 2) í´ë¦­ ìˆ˜ê°€ ë§ì€ í€ë“œ TOP5 -->
  <section class="card col-8">
    <div class="card-header">
      <h3 class="card-title">í´ë¦­ ìˆ˜ê°€ ë§ì€ í€ë“œ TOP 5</h3>
    </div>
    <div id="popularList" class="list"></div>
  </section>

  <!-- (ì•„ë«ì¤„) 4) ì¼ë³„/ì›”ë³„ íŒë§¤ ê¸ˆì•¡ ì¶”ì´ -->
  <section class="card col-6">
    <div class="card-header">
      <h3 class="card-title">ì¼ë³„/ì›”ë³„ íŒë§¤ ê¸ˆì•¡ ì¶”ì´</h3>
      <div class="card-toolbar">
        <label for="salesPeriod" style="font-weight:700">ê¸°ê°„</label>
        <select id="salesPeriod">
          <option value="daily">ì¼ë³„</option>
          <option value="monthly">ì›”ë³„</option>
        </select>
      </div>
    </div>
    <div class="chart-box" id="salesBox">
      <canvas id="salesChart"></canvas>
    </div>
  </section>

  <!-- (ì•„ë«ì¤„) 5) í˜„ì¬ ë“±ë¡ëœ í€ë“œ ìˆ˜ -->
  <section class="card col-6">
    <div class="card-header">
      <h3 class="card-title">í˜„ì¬ ë“±ë¡ëœ í€ë“œ ìˆ˜</h3>
    </div>
    <div class="chart-box" id="fundCountBox">
      <canvas id="fundCountChart"></canvas>
    </div>
  </section>

</div>

    </main>
  </div>
</div>

<script>
  // Chart.js í”ŒëŸ¬ê·¸ì¸
  Chart.register(ChartDataLabels);

  // ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ë³´ê´€
  let salesChart, profileChart, sentimentChart, fundCountChart;

  const API_BASE = '/admin/api/stats';


  // ì§§ì€ ëˆí‘œê¸°
  function fmtMoneyShort(v){
    const n = Number(v)||0;
    if (n >= 100_000_000) return (n/100_000_000).toFixed(1)+'ì–µ';
    if (n >= 10_000)      return Math.round(n/10_000).toLocaleString('ko-KR')+'ë§Œ';
    return n.toLocaleString('ko-KR');
  }
  // ë¼ë²¨ ì§§ê²Œ
  function shortLabel(lbl, period){ return period==='daily' ? String(lbl||'').slice(5) : String(lbl||''); }

  // âœ… ìµœëŒ€ maxPoints ê°œë§Œ ë‚¨ê¸°ê¸° (ê· ë“± ê°„ê²©ìœ¼ë¡œ ìƒ˜í”Œë§, ë§ˆì§€ë§‰ì€ ë³´ì¥)
  function compactSeries(labels, values, maxPoints){
    if (!Array.isArray(labels) || !Array.isArray(values)) return {labels:[], values:[]};
    if (labels.length <= maxPoints) return {labels:[...labels], values:[...values]};
    const step = Math.ceil(labels.length / maxPoints);
    const L=[], V=[];
    for (let i=0; i<labels.length; i+=step){ L.push(labels[i]); V.push(values[i]); }
    if (L[L.length-1] !== labels[labels.length-1]){ L.push(labels.at(-1)); V.push(values.at(-1)); }
    return {labels:L, values:V};
  }

  // 1) íŒë§¤ ì¶”ì´: { labels:[...], values:[...] } or { items:[{label,value}...] } ë“± ë°©ì–´
  const fetchSales = async (period='daily') => {
    const qs = new URLSearchParams({ period });
    if (period === 'monthly') qs.set('months','12');   // ìµœê·¼ 12ê°œì›”
    else qs.set('days','14');                          // ìµœê·¼ 14ì¼

    const url = `${API_BASE}/sales?${qs.toString()}`;
    try{
      const res = await fetch(url, { credentials:'include' });
      const ct = res.headers.get('content-type') || '';
      if (!res.ok || !ct.includes('application/json')) return {labels:[], values:[]};

      const body = await res.json();
      let labels = Array.isArray(body.labels) ? body.labels : (Array.isArray(body.items)? body.items.map(r=>r.label):[]);
      let values = Array.isArray(body.values) ? body.values : (Array.isArray(body.items)? body.items.map(r=>Number(r.value)||0):[]);

      // í˜¹ì‹œ ì„œë²„ê°€ ë” ë§ì´ ì¤˜ë„ í™”ë©´ì€ ìµœëŒ€ 12ê°œë¡œ ì œí•œ
      const MAX_POINTS = 12;
      ({labels, values} = compactSeries(labels, values, MAX_POINTS));

      return { labels, values };
    }catch(e){
      console.warn('[sales] fail', e);
      return { labels: [], values: [] };
    }
  };

  // 2) íŒë§¤ ì¶”ì´ ì°¨íŠ¸ (ë©‹ì§„ ê·¸ë¼ë°ì´ì…˜ + ë‹¨ìœ„/íˆ´íŒ ê°œì„ )
function buildSalesChart(data, period='daily'){
    const ctx = document.getElementById('salesChart').getContext('2d');
    const labels = (data?.labels ?? []).map(l => shortLabel(l, period));
    const values = (data?.values ?? []).map(v => Number(v)||0);
    const hasData = labels.length && values.some(v => v>0);

    if (salesChart) salesChart.destroy();

    // xì¶• ë¼ë²¨/ë¼ë²¨í‘œì‹œ ìƒ˜í”Œë§ ê°„ê²©
    const maxXTicks = 8;
    const step = Math.max(1, Math.ceil(labels.length / maxXTicks));
    const maxV = Math.max(0, ...values);

    salesChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: (period==='monthly'?'ì›”ë³„':'ì¼ë³„') + ' íŒë§¤ ê¸ˆì•¡',
          data: values,
          borderWidth: 0,
          borderRadius: 12,
          barThickness: 18,
          maxBarThickness: 26,
          categoryPercentage: 0.7,
          barPercentage: 0.9,
          backgroundColor: (c)=>{
            const {chart} = c;
            const {ctx, chartArea} = chart;
            if (!chartArea) return 'rgba(0,0,0,0.08)';
            const g = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
            if (period==='monthly'){ g.addColorStop(0,'rgba(255,159,64,0.25)'); g.addColorStop(1,'rgba(255,159,64,0.9)'); }
            else                   { g.addColorStop(0,'rgba(56,189,248,0.25)'); g.addColorStop(1,'rgba(56,189,248,0.9)'); }
            return g;
          }
        }]
      },
      options: withEmptySubtitle({
        responsive:true,
        maintainAspectRatio:false,
        animation:{ duration: 350 },
        layout:{ padding:{ top: 12, right: 8, bottom: 4, left: 8 } },
        plugins:{
          legend:{ display:false },
          tooltip:{
            callbacks:{
              title:(items)=> items?.[0]?.label ?? '',
              label:(ctx)=> ' ' + (Number(ctx.raw)||0).toLocaleString('ko-KR') + ' ì›'
            }
          },
          datalabels:{
            display: hasData,
            formatter:(v,ctx)=>{
              const i = ctx.dataIndex;
              if (v===maxV || i===values.length-1 || i%step===0) return fmtMoneyShort(v);
              return '';
            },
            color:'#2d3748',
            backgroundColor:'rgba(255,255,255,0.85)',
            borderRadius:6,
            padding:4,
            anchor:'end',
            align:'end',
            offset:4,
            clamp:true,
            font:{ weight:'700' }
          }
        },
        scales:{
          x:{
            grid:{ color:'rgba(15,58,83,0.06)' },
            ticks:{
              autoSkip:true,
              maxTicksLimit: maxXTicks,
              maxRotation:0,
              minRotation:0,
              callback:(value, index)=> (index%step===0 ? labels[index] : '')
            },
            border:{ display:false }
          },
          y:{
            beginAtZero:true,
            grace:'10%',
            ticks:{ callback:(v)=> fmtMoneyShort(v) },
            grid:{ color:'rgba(15,58,83,0.06)' },
            border:{ display:false }
          }
        }
      }, !hasData)
    });
  }

  // 2) íˆ¬ì ì„±í–¥ ë¶„í¬: [{ label:'ì•ˆì •í˜•', value: 10 }, ...]
  const fetchInvestorProfiles = async () => {
    try{
      const res = await fetch('/admin/api/stats/investor-profiles', { credentials:'include' });
      if(!res.ok) throw new Error();
      return await res.json();
    }catch(e){ return []; }
  };

  // 5) ë“±ë¡ í€ë“œ ìˆ˜ (ìƒíƒœ/ìœ í˜•ë³„): { labels:[...], values:[...] }
  const fetchFundCounts = async () => {
    try{
      const res = await fetch('/admin/api/stats/funds-count', { credentials:'include' });
      if(!res.ok) throw new Error();
      return await res.json();
    }catch(e){ return { labels:[], values:[] }; }
  };

// ê³µí†µ: ë¹ˆ ìƒíƒœ ì„œë¸Œíƒ€ì´í‹€ ì˜µì…˜
function withEmptySubtitle(baseOptions, empty) {
  return {
    ...baseOptions,
    plugins: {
      ...baseOptions.plugins,
      subtitle: {
        display: empty,
        text: empty ? 'ë°ì´í„° ì—†ìŒ' : '',
        font: { weight: '700' },
        color: '#6b7c93',
        padding: { bottom: 6 }
      }
    }
  };
}

// 2) íˆ¬ì ì„±í–¥ (Doughnut)
function buildProfileChart(rows){
  const ctx = document.getElementById('profileChart').getContext('2d');
  const hasData = rows?.some(r => Number(r.value) > 0);

  const labels = hasData ? rows.map(r=>r.label) : ['ë°ì´í„° ì—†ìŒ'];
  const values = hasData ? rows.map(r=>Number(r.value)||0) : [1];

  if (profileChart) profileChart.destroy();
  profileChart = new Chart(ctx, {
    type:'doughnut',
    data:{ labels, datasets:[{ data: values, borderWidth:1 }] },
    options: withEmptySubtitle({
      responsive:true, maintainAspectRatio:false,
      plugins:{
        legend:{ display: hasData, position:'bottom' },
        datalabels:{ formatter:(v,ctx)=> {
          if(!hasData) return '';
          return v>0? `${v}`:'';
        }, color:'#111', font:{ weight:'700' } }
      },
      cutout:'55%'
    }, !hasData)
  });
}

  // 3) ì¸ê¸° í€ë“œ TOP5: [{ name, company, clicks, users }]
const fetchPopularFunds = async () => {
  try {
    const url = '/admin/api/stats/popular-funds?limit=5';
    const res = await fetch(url, { credentials:'include' });

    // ë„¤íŠ¸ì›Œí¬ ìƒíƒœ ë¡œê·¸
    console.log('[popular-funds] status:', res.status, 'ok:', res.ok, 'redirected:', res.redirected);
    const ct = res.headers.get('content-type') || '';
    console.log('[popular-funds] content-type:', ct);

    if (!res.ok || !ct.includes('application/json')) {
      // ë¡œê·¸ì¸ ë¦¬ë‹¤ì´ë ‰íŠ¸(HTML) ë“±
      const text = await res.text();
      console.warn('[popular-funds] non-json body preview:', text.slice(0, 200));
      return [];
    }

    const raw = await res.json();
    console.log('[popular-funds] raw:', raw);

    // ì„œë²„ê°€ ë°°ì—´ì´ ì•„ë‹Œ {items:[]}/{content:[]} í˜•íƒœì¼ ìˆ˜ ìˆìœ¼ë‹ˆ ì•ˆì „ ì¶”ì¶œ
    const rows =
      Array.isArray(raw) ? raw :
      Array.isArray(raw.items) ? raw.items :
      Array.isArray(raw.data) ? raw.data :
      Array.isArray(raw.content) ? raw.content :
      [];

    // í‚¤ ì´ë¦„ ë§¤í•‘
    const mapped = rows.map(r => ({
      id:      r.id ?? r.fundId ?? r.FUND_ID ?? '',
      name:    r.name ?? r.fundName ?? r.FUND_NAME ?? '',
      company: r.company ?? r.managementCompany ?? r.MANAGEMENT_COMPANY ?? '',
      clicks:  Number(r.clicks ?? r.CLICKS ?? 0) || 0,
      users:   Number(r.users ?? r.USERS ?? 0) || 0,
    }));

    console.log('[popular-funds] mapped:', mapped);
    return mapped;
  } catch (e) {
    console.error('popular-funds load failed:', e);
    return [];
  }
};

  // (ì¤‘ë³µ ì œê±°) buildPopularListëŠ” í•˜ë‚˜ë§Œ ë‚¨ê¸°ì„¸ìš”
function buildPopularList(items){
  const wrap = document.getElementById('popularList');
  wrap.innerHTML = '';
  if(!items?.length){
    const empty = document.createElement('div');
    empty.className = 'empty';
    empty.style.height = '220px';
    empty.textContent = 'ë°ì´í„° ì—†ìŒ';
    wrap.appendChild(empty);
    return;
  }
  items.slice(0,5).forEach((it, idx)=>{
    const li = document.createElement('div');
    li.className = 'list-item';
    li.innerHTML = `
      <span class="rank">${idx+1}</span>
      <div class="item-text" title="${(it.name||'')}${it.company? ' Â· '+it.company : ''}">
        <span class="item-name">${it.name || '-'}</span>
        ${it.company ? `<span class="item-company">Â· ${it.company}</span>` : ''}
      </div>
      <div class="item-metric">
        ${Number(it.clicks ?? 0).toLocaleString()} í´ë¦­ /
        ${Number(it.users ?? 0).toLocaleString()} ëª…
      </div>
    `;
    wrap.appendChild(li);
  });
}


// 5) ë“±ë¡ í€ë“œ ìˆ˜ (Bar)
function buildFundCountChart(data){
  const ctx2d = document.getElementById('fundCountChart').getContext('2d');
  const hasData = (data.labels?.length||0) > 0 && data.values?.some(v => Number(v) > 0);
  const labels = hasData ? data.labels : [''];
  const values = hasData ? data.values.map(v=>Number(v)||0) : [0];

  if (fundCountChart) fundCountChart.destroy();

  fundCountChart = new Chart(ctx2d, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'í€ë“œ ìˆ˜',
        data: values,
        // ğŸ”¥ ê° ë°”ë§ˆë‹¤ ë¼ë²¨ì„ ë³´ê³  ê·¸ë¼ë°ì´ì…˜ ê²°ì • (ê°€ë¡œë§‰ëŒ€ ëŒ€ì‘)
        backgroundColor: (ctx) => {
          const {chart, dataIndex} = ctx;
          const {ctx: c, chartArea} = chart;
          if (!chartArea) return 'rgba(0,0,0,0.08)'; // ì´ˆê¸° ë Œë” íŒ¨ìŠ¤

          // ê°€ë¡œ ë°©í–¥ ê·¸ë¼ë°ì´ì…˜ (left -> right)
          const makeGrad = (from, to) => {
            const g = c.createLinearGradient(chartArea.left, 0, chartArea.right, 0);
            g.addColorStop(0, from);
            g.addColorStop(1, to);
            return g;
          };

          const label = String(chart.data.labels[dataIndex] ?? '').trim();
          const isRunning = label.includes('ìš´ìš©ì¤‘');

          // íŒŒë‘(ê¸°ë³¸) / ë¹¨ê°•(ìš´ìš©ì¤‘) ê·¸ë¼ë°ì´ì…˜
          const blueGrad = makeGrad('rgba(14,122,254,0.92)', 'rgba(14,122,254,0.55)');
          const redGrad  = makeGrad('rgba(239,68,68,0.92)',  'rgba(239,68,68,0.55)');
          return isRunning ? redGrad : blueGrad;
        },
        borderWidth: 0,
        borderRadius: 12,
        barThickness: 36,
        maxBarThickness: 44,
        minBarLength: 6
      }]
    },
    options: withEmptySubtitle({
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      layout: { padding: { top: 8, right: 12, bottom: 8, left: 8 } },
      plugins: {
        legend: { display: false },
        tooltip: { callbacks: { label: (c)=> `${c.raw.toLocaleString()} ê°œ` } },
        datalabels: {
          display: hasData,
          formatter: (v)=> v.toLocaleString(),
          color: '#fff', font: { weight: '800' },
          anchor: 'center', align: 'center', clamp: true
        }
      },
      scales: {
        x: { beginAtZero: true, grace: '10%',
             grid: { color: 'rgba(15,58,83,0.06)' },
             ticks: { callback: (v)=> v.toLocaleString() } },
        y: { grid: { display: false } }
      }
    }, !hasData)
  });
}



  // ===== ì´ˆê¸°í™” =====
  (async function init(){
    // íŒë§¤ ì¶”ì´
    const salesPeriod = document.getElementById('salesPeriod');
    let salesData = await fetchSales(salesPeriod.value);
    buildSalesChart(salesData, salesPeriod.value);

    salesPeriod.addEventListener('change', async ()=>{
      const p = salesPeriod.value;
      const fresh = await fetchSales(p);
      buildSalesChart(fresh, p);
    });

    // 2) íˆ¬ì ì„±í–¥
    const profiles = await fetchInvestorProfiles();
    buildProfileChart(profiles);

    // 3) ì¸ê¸° í€ë“œ
    const popular = await fetchPopularFunds();
    buildPopularList(popular);

    // 5) ë“±ë¡ í€ë“œ ìˆ˜
    const counts = await fetchFundCounts();
    buildFundCountChart(counts);
  })();
</script>
<script>
  // 2x2 íƒ€ì¼ë¡œ ì—¬ëŸ¬ ì¹´ë“œë¥¼ í•œ í˜ì´ì§€ì— ë°°ì¹˜í•´ì„œ PDFë¡œ ì €ì¥
  async function exportDashboardPDFGrid(){
    const cards = Array.from(document.querySelectorAll('.dashboard-grid .card'));
    if (!cards.length) return;

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('l','mm','a4');

    // í˜ì´ì§€Â·ê·¸ë¦¬ë“œ ì„¤ì •
    const margin = 10;          // mm
    const gapX = 6, gapY = 8;   // ì¹´ë“œ ê°„ ê°„ê²©(mm)
    const COLS = 2, ROWS = 2;   // í˜ì´ì§€ ë‹¹ ê°€ë¡œÃ—ì„¸ë¡œ ê°œìˆ˜ (2x2 â†’ í•œ í˜ì´ì§€ ìµœëŒ€ 4ê°œ)

    const pageW = pdf.internal.pageSize.getWidth();
    const pageH = pdf.internal.pageSize.getHeight();
    const usableW = pageW - margin * 2;
    const usableH = pageH - margin * 2;

    const slotW = (usableW - gapX * (COLS - 1)) / COLS;     // ê° ì¹´ë“œê°€ ë“¤ì–´ê°ˆ ì˜ì—­ì˜ ë„ˆë¹„
    const slotH = (usableH - gapY * (ROWS - 1)) / ROWS;     // ê° ì¹´ë“œê°€ ë“¤ì–´ê°ˆ ì˜ì—­ì˜ ë†’ì´

    // ì°¨íŠ¸ ì• ë‹ˆë©”ì´ì…˜ì´ ëë‚˜ë„ë¡ ì ê¹ ëŒ€ê¸°
    await new Promise(r => setTimeout(r, 200));

    let idxOnPage = 0;

    for (let i = 0; i < cards.length; i++) {
      if (i > 0 && idxOnPage === COLS * ROWS) {
        pdf.addPage();
        idxOnPage = 0;
      }

      // ìº¡ì²˜
      const canvas = await html2canvas(cards[i], {
        backgroundColor: '#ffffff',
        scale: 2,          // ê³ í•´ìƒë„
        useCORS: true,
        allowTaint: true
      });

      // ìŠ¬ë¡¯ ìœ„ì¹˜ ê³„ì‚° (ì¢Œì¸¡ìƒë‹¨ ê¸°ì¤€)
      const col = idxOnPage % COLS;
      const row = Math.floor(idxOnPage / COLS);
      const slotX = margin + col * (slotW + gapX);
      const slotY = margin + row * (slotH + gapY);

      // ìŠ¬ë¡¯ì— ë§ê²Œ ë¹„ìœ¨ ìœ ì§€í•˜ë©° ì¶•ì†Œ
      const ratio = canvas.width / canvas.height;
      let drawW = slotW;
      let drawH = drawW / ratio;
      if (drawH > slotH) {           // ì„¸ë¡œ ë„˜ì¹˜ë©´ ì„¸ë¡œ ê¸°ì¤€ìœ¼ë¡œ ë§ì¶¤
        drawH = slotH;
        drawW = drawH * ratio;
      }

      // ìŠ¬ë¡¯ ì¤‘ì•™ ì •ë ¬
      const x = slotX + (slotW - drawW) / 2;
      const y = slotY + (slotH - drawH) / 2;

      pdf.addImage(canvas.toDataURL('image/png'), 'PNG', x, y, drawW, drawH);
      idxOnPage++;
    }

    const fname = `ìƒí’ˆí†µê³„_${new Date().toISOString().slice(0,10)}.pdf`;
    pdf.save(fname);
  }

  // ë²„íŠ¼ì— ì¬ì—°ê²° (ì´ì „ì— ì—°ê²°í•œ í•¨ìˆ˜ê°€ ìˆë”ë¼ë„ ì´ê±¸ë¡œ ë®ì–´ì”€)
  const btn = document.getElementById('btnExportPdf');
  if (btn) {
    btn.onclick = exportDashboardPDFGrid;
  }
</script>


</body>
</html>
