<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <body>
    <aside th:fragment="adminAside" class="admin-aside">
      <nav>
        <ul class="menu-list">
          <li>
            <a th:href="@{/admin/main}">
              <h1 class="semi-title">Fund Admin</h1>
            </a>
          </li>
          <li class="line"></li>
          <!-- ─── 펀드 상품 관리 ─── -->
          <li
            class="menu-group"
            th:if="${session.admin.role == 'planner' or session.admin.role == 'super'}"
          >
            <button type="button" class="group-btn">
              펀드 상품 관리
              <span class="arrow"></span>
            </button>
            <ul class="submenu">
              <li>
                <a
                  th:href="@{/admin/fund/list}"
                  data-url="/admin/fund/list"
                  class="group_a"
                  >펀드 관리</a
                >
              </li>

              <li>
                <a 
                  th:href="@{/admin/fund/recommend}" 
                  data-url="/admin/fund/recommend" 
                  class="group_a"
                  >펀드 추천 관리</a
                >
              </li>

              <li th:if="${session.admin.role == 'planner'}">
                <a
                  th:href="@{/admin/fund/new}"
                  data-url="/admin/fund/new"
                  class="group_a"
                  >펀드 등록</a
                >
              </li>
            </ul>
          </li>

          <!-- ─── 상품 통계 ─── -->
          <li
            class="menu-group"
            th:if="${session.admin.role == 'super' or session.admin.role == 'approver'}"
          >
            <button type="button" class="group-btn">
              상품 통계
              <span class="arrow"></span>
            </button>
            <ul class="submenu">
              <li>
                <a
                  th:href="@{/admin/fund_statistics}"
                  data-url="/admin/fund_statistics"
                  class="group_a"
                  >통계 보기</a
                >
              </li>
            </ul>
          </li>

          <!-- ─── 결재 업무(approver) ─── -->
          <li
            class="menu-group"
            th:if="${session.admin.role == 'approver' or session.admin.role == 'super'}"
          >
            <button
              type="button"
              class="group-btn"
              onclick="approverLink()"
              data-url="/admin/approval/manage"
            >
              결재 업무
            </button>
          </li>

          <!-- ─── 문서함(planner) ─── -->
          <li class="menu-group" th:if="${session.admin.role == 'planner'}">
            <button
              type="button"
              class="group-btn"
              onclick="plannerLink()"
              data-url="/admin/approval/list"
            >
              결재 문서함
            </button>
          </li>
          <!-- ─── 1:1문의 관리(cs) ─── -->
          <li
            th:if="${session.admin.role == 'cs' or session.admin.role == 'super'}"
            class="menu-group"
          >
            <button
              type="button"
              class="group-btn"
              onclick="qnaLink()"
              data-url="/admin/qnaList"
            >
              1:1 문의 관리
            </button>
          </li>

          <!-- ─── FAQ 관리(cs) ─── -->
          <li
            th:if="${session.admin.role == 'cs' or session.admin.role == 'super'}"
            class="menu-group"
          >
            <button
              type="button"
              class="group-btn"
              onclick="faqLink()"
              data-url="/admin/faq/list"
            >
              FAQ 관리
            </button>
          </li>

          <!-- ─── 관리자 설정(super only) ─── -->
          <li th:if="${session.admin.role == 'super'}" class="menu-group">
            <button
              type="button"
              class="group-btn"
              onclick="link()"
              data-url="/admin/adminSetting"
            >
              관리자 설정
            </button>
          </li>

          <!-- ─── 공지사항 관리(super only) ─── -->
          <li th:if="${session.admin.role == 'super'}" class="menu-group">
            <button
              type="button"
              class="group-btn"
              onclick="superNoticeLink()"
              data-url="/admin/notice/list"
            >
              공지사항 관리
            </button>
          </li>

          <!-- ─── 공지사항(super 빼고) ─── -->
          <li th:if="${session.admin.role != 'super'}" class="menu-group">
            <button
              type="button"
              class="group-btn"
              onclick="noticeLink()"
              data-url="/admin/notice/list"
            >
              공지사항
            </button>
          </li>
        </ul>
        <div class="aside-bottom">
          <button
            type="button"
            class="group-btn"
            onclick="openCustomerModal()"
            data-url="/admin/customers"
          >
            고객 조회
          </button>
        </div>
        
<script th:inline="javascript">

/* ───────── 아코디언 & 활성화 + 메뉴 이동 헬퍼 (복구) ───────── */
(function(){
  function setupAside(){
    // 아코디언: submenu가 있는 그룹만 열고닫기
    document.querySelectorAll('.admin-aside .menu-group').forEach(group=>{
      const btn = group.querySelector('.group-btn');
      const submenu = group.querySelector('.submenu');
      if (!btn || !submenu) return;
      btn.addEventListener('click', (e)=>{
        // 이동용 버튼(onclick 있는 경우)은 아코디언 동작 안 함
        if (btn.hasAttribute('onclick')) return;
        group.classList.toggle('open');
      });
    });

    // 현재 경로에 맞춰 활성화 표시
    const path = location.pathname.replace(/\/$/,'');
    document.querySelectorAll('.admin-aside [data-url]').forEach(el=>{
      const url = (el.dataset.url || '').replace(/\/$/,'');
      if (!url || !path.startsWith(url)) return;
      const group = el.closest('.menu-group');
      if (el.classList.contains('group_a')) {
        el.classList.add('active');
        group?.classList.add('open');
        group?.querySelector('.group-btn')?.classList.remove('active');
      } else if (el.classList.contains('group-btn')) {
        el.classList.add('active');
        group?.classList.add('open');
      }
    });
  }

  document.addEventListener('DOMContentLoaded', setupAside);

  // 메뉴 이동 함수들 (onclick 에서 사용)
  window.link            = () => location.href = "/admin/adminSetting";
  window.qnaLink         = () => location.href = "/admin/qnaList";
  window.faqLink         = () => location.href = "/admin/faq/list";
  window.approverLink    = () => location.href = "/admin/approval/manage";
  window.plannerLink     = () => location.href = "/admin/approval/list";
  window.superNoticeLink = () => location.href = "/admin/notice/list";
  window.noticeLink      = () => location.href = "/admin/notice/list";
})();
/* =========================
   0) URL 상수(타임리프로 고정)
========================= */
const API = {
  search: /*[[@{/admin/api/customers/search}]]*/ '/admin/api/customers/search',
  detail: /*[[@{/admin/api/customers/}]]*/ '/admin/api/customers/'
};

/* =========================
   공통 유틸
========================= */
function formatPhone(raw){
  if(!raw) return '-';
  const d = String(raw).replace(/\D/g,'');
  return d.length===11 ? `${d.slice(0,3)}-${d.slice(3,7)}-${d.slice(7)}` : raw;
}
function escapeHtml(s){
  return String(s ?? '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

/* =========================
   모달 열고/닫기
========================= */
function openCustomerModal(){
  const m = document.getElementById('customerModal');
  m.classList.add('is-open');
  document.body.style.overflow = 'hidden';
  document.getElementById('customerResults').innerHTML =
    '<div class="modal__empty">검색어를 입력하고 ‘검색’을 눌러주세요.</div>';
  closeCustomerDetailFlyout({silent:true});
  setTimeout(()=> document.getElementById('customerQuery').focus(), 0);
}
function closeCustomerModal(){
  const m = document.getElementById('customerModal');
  m.classList.remove('is-open');
  document.body.style.overflow = '';
  const box = document.getElementById('customerResults');
  if (box) box.querySelectorAll('.list-row.selected').forEach(el=>el.classList.remove('selected'));
  closeCustomerDetailFlyout({silent:true});
}

/* =========================
   검색(이름/이메일/전화)
========================= */
async function searchCustomers(){
  const q = document.getElementById('customerQuery').value.trim();
  const listBox = document.getElementById('customerResults');

  closeCustomerDetailFlyout({silent:true});

  if (!q){
    listBox.innerHTML = '<div class="modal__empty" style="color:#333">검색어를 입력해주세요.</div>';
    return;
  }
  listBox.innerHTML = '<div class="modal__empty" style="color:#333">검색 중...</div>';

  try{
    const url = `${API.search}?q=${encodeURIComponent(q)}`;
    const res = await fetch(url, { credentials:'include' });

    if(!res.ok){
      const txt = await res.text().catch(()=> '');
      listBox.innerHTML =
        `<div class="modal__empty" style="color:#c00">
           요청 실패 (${res.status})<br/><small>${escapeHtml(txt)}</small>
         </div>`;
      return;
    }

    const rows = await res.json();
    if(!Array.isArray(rows) || rows.length === 0){
      listBox.innerHTML = '<div class="modal__empty" style="color:#333">검색 결과가 없습니다.</div>';
      return;
    }

    const frag = document.createDocumentFragment();
rows.forEach(r => {
  const el = document.createElement('div');
  el.className = 'list-row';

  // [A] 여기! 생성 직후에 클릭할 사용자 id를 data-속성으로 저장
  el.dataset.id = r.id;   // ← 중요

  el.style.cssText = 'display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid #eef2f7;cursor:pointer;color:#333;font-size:14px;';
  el.innerHTML = `
    <span class="name"  style="flex:0 1 28%;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" title="${escapeHtml(r.name??'')}">${escapeHtml(r.name ?? '-')}</span>
    <span class="sep"   style="color:#bbb">•</span>
    <span class="email" style="flex:1 1 52%;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" title="${escapeHtml(r.email??'')}">${escapeHtml(r.email ?? '-')}</span>
    <span class="sep"   style="color:#bbb">•</span>
    <span class="phone" style="white-space:nowrap" title="${escapeHtml(r.phone??'')}">${formatPhone(r.phone)}</span>
  `;

  el.addEventListener('click', async () => {
    const prev = listBox.querySelector('.list-row.selected');
    if (prev) prev.classList.remove('selected');
    el.classList.add('selected');

    try {
      // [B] 여기! r.id 대신 방금 심어둔 data-id 사용
      const id = el.dataset.id;
      if (!id) throw new Error('no user id on row');

      const dres = await fetch(`${API.detail}${id}`, { credentials: 'include' });
      if (!dres.ok) throw new Error(`detail ${dres.status}`);
      openCustomerDetailFlyout(await dres.json(), el);
    } catch (e) {
      openCustomerDetailFlyout({ name: '-', email: '-', phone: '-', username: '-' }, el);
    }
  });

  frag.appendChild(el);
});


    listBox.innerHTML = '';
    listBox.appendChild(frag);

  }catch(e){
    console.warn(e);
    listBox.innerHTML = '<div class="modal__empty" style="color:#c00">조회 중 오류가 발생했습니다.</div>';
  }
}

/* =========================
   상세 플라이아웃 (간소화)
========================= */
function openCustomerDetailFlyout(detail, anchorEl){
  closeCustomerDetailFlyout({ silent:true });

  const body = document.getElementById('customerModalBody');
  const wrap = document.createElement('div');
  wrap.id = 'customerDetailFlyout';
  wrap.className = 'customer-detail-flyout';

  let html = '';
  try {
    console.debug('[customer.detail] incoming detail:', detail);
    html = renderCustomerDetailV2(detail);
  } catch (e) {
    console.error('[customer.detail] render failed', e);
    html = '<div class="modal__empty" style="color:#c00">상세 렌더링 중 오류</div>';
  }

  wrap.innerHTML = `
    <div class="flyout__header">
      <h4 class="flyout__title">고객 상세</h4>
      <div class="flyout__btns">
        <button type="button" id="btnCustomerPdfFlyout" class="btn">PDF 저장</button>
        <button type="button" class="flyout__close" aria-label="닫기">×</button>
      </div>
    </div>
    <div class="flyout__content" id="customerDetailContent">
      ${html}
    </div>
  `;
  body.appendChild(wrap);

  // 위치 계산: anchor 행의 화면 좌표 → 모달 본문 좌표로 변환
  try {
    const bodyRect = body.getBoundingClientRect();
    const rowRect  = anchorEl?.getBoundingClientRect();
    const scrollY  = body.scrollTop;
    const top = rowRect ? (rowRect.top - bodyRect.top + scrollY - 8) : 76;
    wrap.style.top = Math.max(16, top) + 'px';
    wrap.style.right = '12px';
  } catch(_) {
    wrap.style.top = '76px';
    wrap.style.right = '12px';
  }

  wrap.querySelector('.flyout__close')
      .addEventListener('click', ()=> closeCustomerDetailFlyout());
  wrap.querySelector('#btnCustomerPdfFlyout')
      .addEventListener('click', ()=> exportCustomerPdf('customerDetailFlyout'));
}
function closeCustomerDetailFlyout(opts={}){ const el=document.getElementById('customerDetailFlyout'); if(el) el.remove(); }

/* =========================
   렌더(기본+가입 정보)
========================= */
// 유틸: 안전한 키 선택자
function pickId(o){ return o?.id ?? o?.userId ?? o?.memberId ?? o?.uid ?? null; }
function pickName(o){ return o?.name ?? o?.fullName ?? o?.username ?? '-'; }
function pickEmail(o){ return o?.email ?? o?.mail ?? '-'; }
function pickPhone(o){ return o?.phone ?? o?.phoneNumber ?? o?.tel ?? o?.mobile ?? '-'; }

function nnum(v){ const n = Number(v); return Number.isFinite(n) ? n : 0; }
function safeFormatMoney(n){
  try { return Number(n).toLocaleString('ko-KR'); } // MDN 권장 방식. :contentReference[oaicite:0]{index=0}
  catch { return String(n ?? 0); }
}
function safeFormatDate(s){
  try {
    if(!s) return '-';
    const d = new Date(s);
    if (isNaN(d)) return '-';
    const y = d.getFullYear(), m = String(d.getMonth()+1).padStart(2,'0'), day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  } catch { return '-'; }
}

function calcFirstDateFromFunds(funds){
  const list = [];
  for(const f of (Array.isArray(funds) ? funds : [])){ // Array.isArray 사용. :contentReference[oaicite:1]{index=1}
    const dt = f?.firstSubscribedAt ?? f?.joinedAt ?? f?.startDate ?? null;
    if (dt) list.push(dt);
  }
  return list.sort()[0] || null;
}

function renderCustomerDetailV2(detail){
  // 1) 디버깅: 실제 들어온 값 확인
  console.debug('[detail.raw]', detail);

  // 2) 안전 추출 (백엔드가 이미 포맷팅해준 phone 사용)
  const name     = detail?.name ?? '-';
  const email    = detail?.email ?? '-';
  const phone    = detail?.phone ?? '-';
  const username = detail?.username ?? '-';

  const funds = Array.isArray(detail?.funds) ? detail.funds : [];

  // 3) 총액: 서버 totalAssetAmount가 있으면 우선 사용, 없으면 합산
  let totalAmt = Number(detail?.totalAssetAmount);
  if (!Number.isFinite(totalAmt)) {
    totalAmt = funds.reduce((sum, f) => {
      const n = Number(f?.assetAmount);
      return sum + (Number.isFinite(n) ? n : 0);
    }, 0);
  }

  // 4) 최초 가입일: top-level 우선, 없으면 funds에서 가장 빠른 날짜
  const topFirst = detail?.firstSubscribedAt || null;
  // ISO 날짜 문자열(yyyy-MM-dd) → Date
  const toDate = (v) => {
    if (!v) return null;
    const d = new Date(v);
    return isNaN(d) ? null : d;
  };

  let firstDt = toDate(topFirst);
  if (!firstDt && funds.length) {
    const candidates = funds
      .map(f => toDate(f?.firstSubscribedAt))
      .filter(Boolean)
      .sort((a, b) => a - b);
    firstDt = candidates[0] || null;
  }

  const chips = funds.length
    ? `<div class="chips">${funds.map(f => `<span class="chip">${escapeHtml(f?.name ?? '-')}</span>`).join('')}</div>`
    : '-';

  const days = firstDt ? Math.max(0, Math.floor((Date.now() - firstDt.getTime()) / 86400000)) : null;

  // 5) 날짜 포매터(없으면 추가)
  if (typeof formatDate !== 'function') {
    window.formatDate = function(s){
      if (!s) return '-';
      const d = toDate(s);
      if (!d) return '-';
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${d.getFullYear()}-${mm}-${dd}`;
    }
  }

  // 6) 렌더링
  return `
    <h4 class="section-title" style="margin-top:0">기본 정보</h4>
    <div class="kv"><b>이름</b><span>${escapeHtml(name)}</span></div>
    <div class="kv"><b>이메일</b><span>${escapeHtml(email)}</span></div>
    <div class="kv"><b>전화</b><span>${escapeHtml(phone)}</span></div>
    <div class="kv"><b>아이디</b><span>${escapeHtml(username)}</span></div>

    <h4 class="section-title">펀드 가입 정보</h4>
    <div class="kv"><b>가입 펀드</b><span>${chips}</span></div>
    <div class="kv"><b>자산 규모</b><span>${Number.isFinite(totalAmt) ? totalAmt.toLocaleString('ko-KR')+'원' : '-'}</span></div>
    <div class="kv"><b>가입 기간</b><span>${firstDt ? `D+${days} (최초 ${formatDate(firstDt)})` : '-'}</span></div>
  `;
}

/* =========================
   PDF (상세만 출력)
========================= */
async function exportCustomerPdf(targetId='customerDetailFlyout'){
  await ensureLib('html2canvas','https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js');
  await ensureLib('jspdf','https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js');

  const target = document.getElementById(targetId)?.querySelector('.flyout__content');
  if (!target) return alert('출력할 상세 내용이 없습니다.');

  const { jsPDF } = window.jspdf;
  const canvas = await window.html2canvas(target,{ scale:2, backgroundColor:'#ffffff' });
  const img = canvas.toDataURL('image/png');

  const pdf = new jsPDF({ orientation:'p', unit:'pt', format:'a4' });
  const pageW = pdf.internal.pageSize.getWidth();
  const pageH = pdf.internal.pageSize.getHeight();
  const margin = 24;

  let imgW = pageW - margin*2;
  let imgH = imgW * (canvas.height / canvas.width);
  if (imgH > pageH - margin*2){ const r=(pageH-margin*2)/imgH; imgH=pageH-margin*2; imgW=imgW*r; }
  pdf.addImage(img,'PNG',(pageW-imgW)/2,margin,imgW,imgH,'','FAST');
  pdf.save(`고객상세_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.pdf`);
}
function ensureLib(globalKey, url){
  return new Promise((resolve, reject) => {
    if (window[globalKey]) return resolve();
    const s = document.createElement('script');
    s.src = url; s.async = true;
    s.onload = () => resolve();
    s.onerror = () => reject(new Error('failed to load ' + url));
    document.head.appendChild(s);
  });
}

/* =========================
   엔터 서치 + 전역 노출
========================= */
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('customerSearchForm');
  if (form) form.addEventListener('submit', (e)=>{ e.preventDefault(); searchCustomers(); });
  const q = document.getElementById('customerQuery');
  if (q) q.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); searchCustomers(); }});
});

// 버튼에서 호출 가능하도록 전역에 바인딩
window.openCustomerModal   = openCustomerModal;
window.closeCustomerModal  = closeCustomerModal;
window.searchCustomers     = searchCustomers;
</script>


      </nav>

        <!-- 고객 조회 모달 -->
        <div id="customerModal" class="modal">
          <div class="modal__backdrop" onclick="closeCustomerModal()"></div>
          <div class="modal__dialog" role="dialog" aria-modal="true" aria-labelledby="customerModalTitle">
            <div class="modal__header">
              <h3 id="customerModalTitle">고객 조회</h3>
              <button class="modal__close" aria-label="닫기" onclick="closeCustomerModal()">×</button>
            </div>

            <div class="modal__body" id="customerModalBody">
              <form id="customerSearchForm" class="modal__search" onsubmit="return false;">
                <input id="customerQuery" type="text" placeholder="이름, 이메일, 전화번호 등으로 검색" />
                <button type="button" onclick="searchCustomers()">검색</button>
              </form>

              <div id="customerResults" class="modal__results">
                <!-- 검색 결과 렌더링 영역 -->
                <div class="modal__empty">검색어를 입력하고 ‘검색’을 눌러주세요.</div>
              </div>
            </div>
          </div>
        </div>
    </aside>
  </body>
</html>
