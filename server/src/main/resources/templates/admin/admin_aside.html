<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <body>
    <aside th:fragment="adminAside" class="admin-aside">
      <nav>
        <ul class="menu-list">
          <li>
            <a th:href="@{/admin/main}">
              <h1 class="semi-title">Fund Admin</h1>
            </a>
          </li>
          <li class="line"></li>
          <!-- ─── 펀드 상품 관리 ─── -->
          <li
            class="menu-group"
            th:if="${session.admin.role == 'planner' or session.admin.role == 'super'}"
          >
            <button type="button" class="group-btn">
              펀드 상품 관리
              <span class="arrow"></span>
            </button>
            <ul class="submenu">
              <li>
                <a
                  th:href="@{/admin/fund/list}"
                  data-url="/admin/fund/list"
                  class="group_a"
                  >펀드 관리</a
                >
              </li>

              <li>
                <a 
                  th:href="@{/admin/fund/recommend}" 
                  data-url="/admin/fund/recommend" 
                  class="group_a"
                  >펀드 추천 관리</a
                >
              </li>

              <li th:if="${session.admin.role == 'planner'}">
                <a
                  th:href="@{/admin/fund/new}"
                  data-url="/admin/fund/new"
                  class="group_a"
                  >펀드 등록</a
                >
              </li>
            </ul>
          </li>

          <!-- ─── 상품 통계 ─── -->
          <li
            class="menu-group"
            th:if="${session.admin.role == 'super' or session.admin.role == 'approver'}"
          >
            <button type="button" class="group-btn">
              상품 통계
              <span class="arrow"></span>
            </button>
            <ul class="submenu">
              <li>
                <a
                  th:href="@{/admin/fund_statistics}"
                  data-url="/admin/fund_statistics"
                  class="group_a"
                  >통계 보기</a
                >
              </li>
            </ul>
          </li>

          <!-- ─── 결재 업무(approver) ─── -->
          <li
            class="menu-group"
            th:if="${session.admin.role == 'approver' or session.admin.role == 'super'}"
          >
            <button
              type="button"
              class="group-btn"
              onclick="approverLink()"
              data-url="/admin/approval/manage"
            >
              결재 업무
            </button>
          </li>

          <!-- ─── 문서함(planner) ─── -->
          <li class="menu-group" th:if="${session.admin.role == 'planner'}">
            <button
              type="button"
              class="group-btn"
              onclick="plannerLink()"
              data-url="/admin/approval/list"
            >
              결재 문서함
            </button>
          </li>
          <!-- ─── 1:1문의 관리(cs) ─── -->
          <li
            th:if="${session.admin.role == 'cs' or session.admin.role == 'super'}"
            class="menu-group"
          >
            <button
              type="button"
              class="group-btn"
              onclick="qnaLink()"
              data-url="/admin/qnaList"
            >
              1:1 문의 관리
            </button>
          </li>

          <!-- ─── FAQ 관리(cs) ─── -->
          <li
            th:if="${session.admin.role == 'cs' or session.admin.role == 'super'}"
            class="menu-group"
          >
            <button
              type="button"
              class="group-btn"
              onclick="faqLink()"
              data-url="/admin/faq/list"
            >
              FAQ 관리
            </button>
          </li>

          <!-- ─── 관리자 설정(super only) ─── -->
          <li th:if="${session.admin.role == 'super'}" class="menu-group">
            <button
              type="button"
              class="group-btn"
              onclick="link()"
              data-url="/admin/adminSetting"
            >
              관리자 설정
            </button>
          </li>

          <!-- ─── 공지사항 관리(super only) ─── -->
          <li th:if="${session.admin.role == 'super'}" class="menu-group">
            <button
              type="button"
              class="group-btn"
              onclick="superNoticeLink()"
              data-url="/admin/notice/list"
            >
              공지사항 관리
            </button>
          </li>

          <!-- ─── 공지사항(super 빼고) ─── -->
          <li th:if="${session.admin.role != 'super'}" class="menu-group">
            <button
              type="button"
              class="group-btn"
              onclick="noticeLink()"
              data-url="/admin/notice/list"
            >
              공지사항
            </button>
          </li>
        </ul>
        <div class="aside-bottom">
          <button
            type="button"
            class="group-btn"
            onclick="openCustomerModal()"
            data-url="/admin/customers"
          >
            고객 조회
          </button>
        </div>
        <!-- 아코디언 토글 스크립트 -->
    <script th:inline="javascript">
    /* ───────── 아코디언 & 활성화 표시 ───────── */
    document.querySelectorAll(".admin-aside .group-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        const grp = btn.closest(".menu-group");
        if (grp.querySelector(".group_a.active")) return; // 현재 페이지면 토글 안함
        grp.classList.toggle("open");
      });
    });
    function link(){ location.href="/admin/adminSetting"; }
    function qnaLink(){ location.href="/admin/qnaList"; }
    function faqLink(){ location.href="/admin/faq/list"; }
    function approverLink(){ location.href="/admin/approval/manage"; }
    function plannerLink(){ location.href="/admin/approval/list"; }
    function superNoticeLink(){ location.href="/admin/notice/list"; }
    function noticeLink(){ location.href="/admin/notice/list"; }

    document.addEventListener("DOMContentLoaded", () => {
      const path = window.location.pathname.replace(/\/$/, "");
      document.querySelectorAll(".admin-aside .group-btn.active, .admin-aside .group_a.active")
              .forEach((el) => el.classList.remove("active"));
      document.querySelectorAll(".admin-aside [data-url]").forEach((el) => {
        const url = el.dataset.url.replace(/\/$/, "");
        if (!path.startsWith(url)) return;
        const menuGroup = el.closest(".menu-group");
        if (el.tagName === "BUTTON") {
          el.classList.add("active"); if (menuGroup) menuGroup.classList.add("open");
        } else {
          el.classList.add("active");
          if (menuGroup) {
            menuGroup.classList.add("open");
            const btn = menuGroup.querySelector(".group-btn");
            if (btn) btn.classList.remove("active");
          }
        }
      });
    });

    /* ───────── 고객 모달 열고/닫기 ───────── */
    function openCustomerModal(){
      const m = document.getElementById('customerModal');
      m.classList.add('is-open');
      document.body.style.overflow = 'hidden';
      // 리스트/상세 초기화
      document.getElementById('customerResults').innerHTML =
        '<div class="modal__empty">검색어를 입력하고 ‘검색’을 눌러주세요.</div>';
      closeCustomerDetailFlyout({silent:true});
      document.addEventListener('keydown', escCloseOnce);
    }
    function closeCustomerModal(){
      const m = document.getElementById('customerModal');
      m.classList.remove('is-open');
      document.body.style.overflow = '';
      document.removeEventListener('keydown', escCloseOnce);
      // 선택/상세 초기화
      const box = document.getElementById('customerResults');
      if (box) box.querySelectorAll('.list-row.selected').forEach(el=>el.classList.remove('selected'));
      closeCustomerDetailFlyout({silent:true});
    }
    function escCloseOnce(e){ if(e.key === 'Escape') closeCustomerModal(); }

    /* ───────── 검색: 이름/이메일/전화 한 줄 리스트 ───────── */
    async function searchCustomers(){
      const q = document.getElementById('customerQuery').value.trim();
      const listBox = document.getElementById('customerResults');

      closeCustomerDetailFlyout({silent:true});

      if (!q){
        listBox.innerHTML = '<div class="modal__empty" style="color:#333">검색어를 입력해주세요.</div>';
        return;
      }
      listBox.innerHTML = '<div class="modal__empty" style="color:#333">검색 중...</div>';

      try{
        const res = await fetch(`/admin/api/customers/search?q=${encodeURIComponent(q)}`, { credentials:'include' });
        if(!res.ok) throw new Error('search failed');
        const rows = await res.json();

        if(!Array.isArray(rows) || rows.length === 0){
          listBox.innerHTML = '<div class="modal__empty" style="color:#333">검색 결과가 없습니다.</div>';
          return;
        }

        const frag = document.createDocumentFragment();
        rows.forEach(r=>{
          const el = document.createElement('div');
          el.className = 'list-row';
          el.innerHTML = `
            <span class="name"  title="${r.name ?? ''}">${r.name ?? '-'}</span>
            <span class="sep">•</span>
            <span class="email" title="${r.email ?? ''}">${r.email ?? '-'}</span>
            <span class="sep">•</span>
            <span class="phone" title="${r.phone ?? ''}">${formatPhone(r.phone)}</span>
          `;
          el.addEventListener('click', async ()=>{
            const prev = listBox.querySelector('.list-row.selected');
            if (prev) prev.classList.remove('selected');
            el.classList.add('selected');

            try{
              const dres = await fetch(`/admin/api/customers/${r.id}`, { credentials:'include' });
              if(!dres.ok) throw new Error();
              openCustomerDetailFlyout(await dres.json());
            }catch(e){
              openCustomerDetailFlyout({ name:'-', email:'-', phone:'-', username:'-' });
            }
          });
          frag.appendChild(el);
        });

        listBox.innerHTML = '';
        listBox.appendChild(frag);

      }catch(e){
        console.warn(e);
        listBox.innerHTML = '<div class="modal__empty" style="color:#333">조회 중 오류가 발생했습니다.</div>';
      }
    }

    /* ───────── 상세 플라이아웃 (X 닫기 + 내부 PDF 버튼) ───────── */
    function openCustomerDetailFlyout(detail){
      closeCustomerDetailFlyout({silent:true});
      const body = document.getElementById('customerModalBody');

      const wrap = document.createElement('div');
      wrap.id = 'customerDetailFlyout';
      wrap.className = 'customer-detail-flyout';
      wrap.innerHTML = `
        <div class="flyout__header">
          <h4 class="flyout__title">고객 상세</h4>
          <div class="flyout__btns">
            <button type="button" id="btnCustomerPdfFlyout" class="btn">PDF 저장</button>
            <button type="button" class="flyout__close" aria-label="닫기">×</button>
            </div>
            </div>
         <div class="flyout__content" id="customerDetailContent">
           ${renderCustomerDetailV2(detail)}
         </div>
      `;
      body.appendChild(wrap);

      wrap.querySelector('.flyout__close').addEventListener('click', ()=> closeCustomerDetailFlyout());
      wrap.querySelector('#btnCustomerPdfFlyout').addEventListener('click', ()=> exportCustomerPdf('customerDetailFlyout'));
    }
    function closeCustomerDetailFlyout(opts={}){
      const el = document.getElementById('customerDetailFlyout');
      if (el) el.remove();
      if (!opts.silent){
        const listBox = document.getElementById('customerResults');
        if (listBox) listBox.querySelectorAll('.list-row.selected').forEach(v=>v.classList.remove('selected'));
      }
    }

    /* ───────── 상세 렌더 & 유틸 ───────── */
function renderCustomerDetail(d){
  // funds: [{name, assetAmount, subscribedAt}], firstSubscribedAt, totalAssetAmount
  const funds = Array.isArray(d.funds) ? d.funds : [];

  const totalAmt = (d.totalAssetAmount != null)
    ? Number(d.totalAssetAmount)
    : funds.reduce((s,f)=> s + (Number(f.assetAmount)||0), 0);

  // 최초 가입일: 서버가 주면 사용, 없으면 funds에서 MIN
   const firstDt = d.firstSubscribedAt
    || (funds.map(f=>f.firstSubscribedAt).filter(Boolean).sort()[0] || null);

  const dday = firstDt ? computeDday(firstDt) : '-';

  const fundNames = funds.map(f => escapeHtml(f.name || '-'));
  const chips = fundNames.length
    ? `<div class="chips">${fundNames.map(n=>`<span class="chip">${n}</span>`).join('')}</div>`
    : '-';

  return `
    <h4 class="section-title" style="margin-top:0">기본 정보</h4>
    <div class="kv"><b>이름</b><span>${escapeHtml(d.name ?? '-')}</span></div>
    <div class="kv"><b>이메일</b><span>${escapeHtml(d.email ?? '-')}</span></div>
    <div class="kv"><b>전화</b><span>${formatPhone(d.phone)}</span></div>
    <div class="kv"><b>아이디</b><span>${escapeHtml(d.username ?? '-')}</span></div>

    <h4 class="section-title">펀드 가입 정보</h4>
    <div class="kv"><b>가입 펀드</b><span>${chips}</span></div>
    <div class="kv"><b>자산 규모</b><span>${formatKRW(totalAmt)}</span></div>
    <div class="kv"><b>가입 기간</b><span>${firstDt ? `${dday} (최초 ${formatDate(firstDt)})` : '-'}</span></div>
  `;
}

window._lastCustomerDetail = null;

function renderCustomerDetailV2(d){
  try{
    window._lastCustomerDetail = d;

    const funds = Array.isArray(d?.funds) ? d.funds : [];

    // 총 자산(서버 totalAssetAmount 우선, 없으면 funds 합)
    const totalAmt =
      Number.isFinite(Number(d?.totalAssetAmount))
        ? Number(d.totalAssetAmount)
        : funds.reduce((s,f)=> s + (Number(f?.assetAmount)||0), 0);

    // 최초 가입일: 전체(firstSubscribedAt) 없으면 각 펀드의 firstSubscribedAt 중 최솟값
    const firstDt =
      d?.firstSubscribedAt ||
      (funds.map(f=>f?.firstSubscribedAt).filter(Boolean).sort()[0] || null);

    const dday = firstDt ? computeDday(firstDt) : '-';

    // 가입 펀드명 칩
    const chips = funds.length
      ? `<div class="chips">${funds.map(f=>`<span class="chip">${escapeHtml(f?.name||'-')}</span>`).join('')}</div>`
      : '-';

    return `
      <h4 class="section-title" style="margin-top:0">기본 정보</h4>
      <div class="kv"><b>이름</b><span>${escapeHtml(d?.name ?? '-')}</span></div>
      <div class="kv"><b>이메일</b><span>${escapeHtml(d?.email ?? '-')}</span></div>
      <div class="kv"><b>전화</b><span>${formatPhone(d?.phone)}</span></div>
      <div class="kv"><b>아이디</b><span>${escapeHtml(d?.username ?? '-')}</span></div>

      <h4 class="section-title">펀드 가입 정보</h4>
      <div class="kv"><b>가입 펀드</b><span>${chips}</span></div>
      <div class="kv"><b>자산 규모</b><span>${formatKRW(totalAmt)}</span></div>
      <div class="kv"><b>가입 기간</b><span>${firstDt ? `${dday} (최초 ${formatDate(firstDt)})` : '-'}</span></div>
    `;
  }catch(e){
    console.warn('renderCustomerDetailV2 error', e, d);
    // 오류가 나도 섹션은 보이게 최소 마크업 반환
    return `
      <h4 class="section-title" style="margin-top:0">기본 정보</h4>
      <div class="kv"><b>이름</b><span>${escapeHtml(d?.name ?? '-')}</span></div>
      <div class="kv"><b>이메일</b><span>${escapeHtml(d?.email ?? '-')}</span></div>
      <div class="kv"><b>전화</b><span>${formatPhone(d?.phone)}</span></div>
      <div class="kv"><b>아이디</b><span>${escapeHtml(d?.username ?? '-')}</span></div>
      <h4 class="section-title">펀드 가입 정보</h4>
      <div class="kv"><b>가입 펀드</b><span>-</span></div>
      <div class="kv"><b>자산 규모</b><span>-</span></div>
      <div class="kv"><b>가입 기간</b><span>-</span></div>
    `;
  }
}

/* ===== 유틸 ===== */
  function computeDday(dateStr){
    const d = new Date(dateStr);
    if (isNaN(d)) return '-';
    const today = new Date();
    // 자정 기준 일수차
    const a = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    const b = new Date(d.getFullYear(), d.getMonth(), d.getDate());
    const days = Math.floor((a - b) / 86400000);
    return `D+${Math.max(0, days)}`;
  }
  function formatKRW(n){
    const v = Number(n);
    if (!isFinite(v)) return '-';
    return v.toLocaleString('ko-KR') + '원';
  }
  function formatDate(dateStr){
    const d = new Date(dateStr); if (isNaN(d)) return '-';
    const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${da}`;
  }
  function escapeHtml(s){
    return String(s ?? '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

    function formatPhone(raw){
      if(!raw) return '-';
      const digits = String(raw).replace(/\D/g,'');
      return digits.length === 11 ? `${digits.slice(0,3)}-${digits.slice(3,7)}-${digits.slice(7)}` : raw;
    }

    /* ───────── PDF (상세 창만 출력) ───────── */
    async function exportCustomerPdf(targetId='customerDetailFlyout'){
      await ensureLib('html2canvas','https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js');
      await ensureLib('jspdf','https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js');

      const target = document.getElementById(targetId);
      const content = target?.querySelector('.flyout__content');
      if (!content){ alert('출력할 상세 내용이 없습니다.'); return; }

      const jsPDFCtor = (window.jspdf && window.jspdf.jsPDF) || window.jsPDF;
      if (!jsPDFCtor) { alert('PDF 모듈을 불러오지 못했습니다.'); return; }
      const canvas = await window.html2canvas(content,{ scale:2, backgroundColor:'#ffffff' });
      const img = canvas.toDataURL('image/png');

      const pdf = new jsPDF({ orientation:'p', unit:'pt', format:'a4' });
      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();
      const margin = 24;

      let imgW = pageW - margin*2;
      let imgH = imgW * (canvas.height / canvas.width);
      if (imgH > pageH - margin*2){
        const ratio = (pageH - margin*2) / imgH;
        imgH = pageH - margin*2; imgW = imgW * ratio;
      }
      pdf.addImage(img,'PNG',(pageW - imgW)/2,margin,imgW,imgH,'','FAST');
      const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
      pdf.save(`고객상세_${stamp}.pdf`);
    }

    function ensureLib(globalKey, url){
      return new Promise((resolve, reject) => {
        if (window[globalKey]) return resolve();
        const s = document.createElement('script');
        s.src = url; s.async = true;
        s.onload = () => resolve();
        s.onerror = () => reject(new Error('failed to load ' + url));
        document.head.appendChild(s);
      });
    }
    </script>

      </nav>

        <!-- 고객 조회 모달 -->
        <div id="customerModal" class="modal">
          <div class="modal__backdrop" onclick="closeCustomerModal()"></div>
          <div class="modal__dialog" role="dialog" aria-modal="true" aria-labelledby="customerModalTitle">
            <div class="modal__header">
              <h3 id="customerModalTitle">고객 조회</h3>
              <button class="modal__close" aria-label="닫기" onclick="closeCustomerModal()">×</button>
            </div>

            <div class="modal__body" id="customerModalBody">
              <form id="customerSearchForm" class="modal__search" onsubmit="return false;">
                <input id="customerQuery" type="text" placeholder="이름, 이메일, 전화번호 등으로 검색" />
                <button type="button" onclick="searchCustomers()">검색</button>
              </form>

              <div id="customerResults" class="modal__results">
                <!-- 검색 결과 렌더링 영역 -->
                <div class="modal__empty">검색어를 입력하고 ‘검색’을 눌러주세요.</div>
              </div>
            </div>
          </div>
        </div>
    </aside>
  </body>
</html>
