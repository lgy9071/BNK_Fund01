<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>construction page</title>
  <link rel="stylesheet" href="/css/admin/admin_layout.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

  <style>
    .layout { display:flex; flex-direction:column; height:100%; }
    .main-wrapper { display:flex; flex:1; }
    main.content { display:flex; flex-direction:column; align-items:center; justify-content:center; flex:1; padding:24px; }

    /* ì¹´ë“œ */
    .chart-card {
      width: min(840px, 92vw);
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.06);
      padding: 24px 28px 32px;
    }
    .chart-title {
      font-size: clamp(18px, 2.4vw, 28px);
      font-weight: 800;
      color: #0f3a53;
      letter-spacing: 0.02em;
      text-align: center;
      margin: 4px 0 20px;
    }

    /* ì´ ê±´ìˆ˜ ë±ƒì§€ */
    .count-badge-wrap { display:flex; justify-content:center; margin-top:18px; }
    .count-badge {
      display:inline-block;
      padding: 12px 18px;
      background: #f3f7fb;
      color:#1b2b38;
      border-radius: 14px;
      font-weight:700;
      box-shadow: 0 6px 16px rgba(15,58,83,0.08);
    }

    /* ìº”ë²„ìŠ¤ ë†’ì´ ê³ ì •(ë°˜ì‘í˜•) */
    .chart-box { position:relative; height: 360px; }
    @media (max-width: 520px) {
      .chart-box { height: 300px; }
    }
  </style>
</head>
<body>
<div class="layout">
  <div th:replace="admin/admin_header :: adminHeader"></div>
  <div class="main-wrapper">
    <div th:replace="admin/admin_aside :: adminAside"></div>
    <main class="content">

      <!-- ì°¨íŠ¸ ì¹´ë“œ -->
      <section class="chart-card">
        <h2 class="chart-title">ğŸ“Š FAQ ì¹´í…Œê³ ë¦¬ ë¶„í¬ (TOP 3)</h2>
        <div class="chart-box">
          <canvas id="faqTop3Chart" aria-label="FAQ ì¹´í…Œê³ ë¦¬ ë¶„í¬ ë°” ì°¨íŠ¸" role="img"></canvas>
        </div>
        <div class="count-badge-wrap">
          <span class="count-badge" id="totalCountBadge">ì´ 0ê±´:</span>
        </div>
      </section>

    </main>
  </div>
</div>

<script>
  // ì „ì—­ í”ŒëŸ¬ê·¸ì¸ ë“±ë¡
  Chart.register(ChartDataLabels);

  /**
   * ì„œë²„ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
   * ì‘ë‹µ ì˜ˆì‹œ: [{ label: "ê²°ì œ", value: 12 }, { label: "ê³„ì •", value: 7 }, { label: "ì˜ˆì•½", value: 4 }]
   * ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì‹¤ì œ APIë¡œ êµì²´í•˜ì„¸ìš”.
   */
  async function fetchFaqTop3() {
    try {
      const res = await fetch('/admin/api/faq/categories?limit=3', { credentials: 'include' });
      if (!res.ok) throw new Error('Failed to fetch');
      const data = await res.json();
      return Array.isArray(data) ? data : [];
    } catch (e) {
      console.warn('FAQ ì°¨íŠ¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
      return [];
    }
  }

  function buildChart(ctx, rows) {
    // ë¹ˆ ë°ì´í„°ì¼ ë•Œë„ ì¶•/ê·¸ë¦¬ë“œê°€ ë³´ì´ë„ë¡ ìµœì†Œê°’/ìµœëŒ€ê°’ íŒíŠ¸ ì œê³µ
    const labels = rows.map(r => r.label);
    const values = rows.map(r => Number(r.value) || 0);
    const total = values.reduce((a, b) => a + b, 0);

    // ì´ ê±´ìˆ˜ ë±ƒì§€ ì—…ë°ì´íŠ¸
    document.getElementById('totalCountBadge').textContent = `ì´ ${total.toLocaleString()}ê±´:`;

    // ë°ì´í„°ê°€ ì „í˜€ ì—†ìœ¼ë©´ ë³´ì¡°ê°’ìœ¼ë¡œ 0 í•˜ë‚˜ë¥¼ ë‘¬ì„œ ì¶•ë§Œ ë Œë”ë§
    const hasData = values.some(v => v > 0);
    const safeLabels = hasData ? labels : [''];
    const safeValues = hasData ? values : [0];

    const chart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: safeLabels,
        datasets: [{
          label: 'ê±´ìˆ˜',
          data: safeValues,
          borderWidth: 1,
          // ìƒ‰ìƒì€ ê¸°ë³¸ê°’(í…Œë§ˆ)ì— ë§¡ê¹€ â€“ ìš”ì²­ì‚¬í•­ì— ë§ì¶° íŠ¹ì • ìƒ‰ ë¯¸ì§€ì •
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        layout: { padding: { top: 8 } },
        plugins: {
          legend: { display: false },
          tooltip: { enabled: true },
          datalabels: {
            // ê°’ì´ 0ì´ë©´ ë¼ë²¨ ìˆ¨ê¹€
            formatter: (v) => (v > 0 ? v : ''),
            anchor: 'end',
            align: 'end',
            offset: 4,
            clamp: true
          },
          title: { display: false }
        },
        scales: {
          x: {
            grid: { display: true },
            ticks: { font: { weight: '600' } }
          },
          y: {
            beginAtZero: true,
            // ë°ì´í„°ê°€ ì—†ì„ ë•Œë„ ê·¸ë¦¬ë“œ ë³´ì´ê²Œ ì‚´ì§ ìƒí•œ ì œì•ˆ
            suggestedMax: hasData ? undefined : 1,
            grid: { display: true },
            ticks: {
              precision: 0 // ì •ìˆ˜ ëˆˆê¸ˆ
            }
          }
        }
      }
    });

    return chart;
  }

  (async function init() {
    const ctx = document.getElementById('faqTop3Chart').getContext('2d');
    const rows = await fetchFaqTop3();

    // ìƒìœ„ 3ê°œë§Œ ë³´ì¥(ì„œë²„ê°€ ì •ë ¬í•˜ì§€ ì•ŠëŠ” ê²½ìš° ëŒ€ë¹„)
    const top3 = rows
      .map(r => ({ label: String(r.label ?? ''), value: Number(r.value) || 0 }))
      .sort((a, b) => b.value - a.value)
      .slice(0, 3);

    buildChart(ctx, top3);
  })();
</script>
</body>
</html>
